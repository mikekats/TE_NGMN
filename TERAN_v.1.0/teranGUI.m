function hMainFigure = teranGUI(inputs_market_industry, inputs_technology, inputs_costs, inputs_finance,...
                                site_infrastructure, network_information, network_cost, network_energy, network_throughput_progression,...
                                inputs_demand_parameters,market_demand_revenues)
% Techno-economics of Radio Access Networks
% version: 1
% date: August-November 2017
% developer: Michail Katsigiannis


%**************************************************************************
% Initialization tasks - phase 1
%**************************************************************************
sites_x = [site_infrastructure.longitude];
sites_y = [site_infrastructure.latitude];
area = sqrt(inputs_market_industry.demographics.land_Area_km2)/2*[-1 1 -1 1]*1000; % meters
resolution = 1;
[SR_MobileDataTraffic_TB_mon, SR_MobileDataTraffic_DL_TB_mon, current_point, OPEX_total, network_throughput_regional_TB_mon,...                                 
    Max_Traffic_to_be_satisfied_regional_TB_mon, Max_Traffic_to_be_satisfied_regional_DL_TB_mon,actual_max_network_capacity_regional_DL_TB_mon,... 
    Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon, Max_Traffic_to_be_satisfied_techlimit_regional_DL_TB_mon,...
    Average_Total_Cost,Average_Total_Cost_current, Average_Fixed_Cost,Average_Variable_Cost,Marginal_Cost,...
    Efix_net, Evar_net, Average_Total_Cost_of_GB, Average_user_data,...
    SR_RAN_operating_cost_structure,SR_Total_operating_cost_structure]...
    =  initial_figure_calculations_SR();     

[table_p3_headers,table_p3_columnwidth,table_p3_colFormat,table_p3_data]   =  create_table_income_statement_data(); 



%**************************************************************************
% Construct the components
%**************************************************************************

% figure
hMainFigure = figure(...
            'Color', [0.8 0.8 0.8], ...
            'Visible','off',...
            'Units','normalized',...
            'Position',[0.1,0.1,0.8,0.7],...
            'Name','TE-RAN',...
            'Tag','mainFig',...
            'NumberTitle','off',...
            'Resize','on',...
            'MenuBar', 'figure',...
            'Toolbar','auto',...
            'ResizeFcn',@resizeui,...
            'CloseRequestFcn', @programQuit); 

% axis
ah = axes(...
            'Parent',hMainFigure,...
            'Units', 'normalized', ...
            'HandleVisibility','on', ...
            'Box','On',...
            'XTick', [],...
            'YTick', [],...
            'Position',[0.3 0.19 0.4 0.8]);        

        
% Menu bar            
hmenuSiteOptions = uimenu(...,
                        'Parent',hMainFigure,...
                        'Callback', '', ...
                        'Label', 'Site options');

hImportSites = uimenu(...
                        'Parent',hmenuSiteOptions,...
                        'Label','Import sites from file',...
                        'Tag','ImportSites',...
                        'Callback',@importFILE);
                    
hExportSites = uimenu(...
                        'Parent',hmenuSiteOptions,...
                        'Label','Emport sites to file',...
                        'Tag','ImportSites',...
                        'Callback',@exportFILE);
                    
hmenuAddSite = uimenu(...,
                    'Parent',hmenuSiteOptions,...
                    'Callback', '', ...
                    'Label', 'Add site', ...
                    'Tag', 'AddSitetag',...
                    'Separator','on',...
                    'Callback',@add_site);     

% panel_1: Information about sites and cells 
hpanel1 = uipanel(...
                'parent',hMainFigure,...
                'Title','',...
                'Units', 'normalized', ...
                'Position',[0.01 0.54 0.12 0.45]);               

hPlotRANpopupmenu =   uicontrol(...    % list of available RAN
                        'Parent', hpanel1, ...
                        'Style','popupmenu',...
                        'Units','normalized',...
                        'Position',[0 0.9 1 0.1],...
                        'HandleVisibility','callback', ...
                        'String',['All RAN';network_information.all_RAN.configurations],...
                        'Callback',@PlotRANpopupmenu);  
                    
hRooftopcheckbox = uicontrol(...
                            'Parent',hpanel1,...
                            'Style', 'checkbox',...
                            'Units', 'normalized',...
                            'Position', [.015 .8 .45 .12],...
                            'TooltipString', sprintf('Show Rooftop sites.\nOwned in blue, Rented in red, Shared in green'),...
                            'String', 'Rooftop',...
                            'Value', 0,...
                            'HandleVisibility','on', ...
                            'Callback', {@plotSiteTypes,1});
  
hTowercheckbox  =  uicontrol(...
                            'Parent',hpanel1,...
                            'Style', 'checkbox',...
                            'Units', 'normalized',...
                            'Position', [.5 .8 .45 .12],...
                            'TooltipString', sprintf('Show Tower sites.\nOwned in blue, Rented in red, Shared in green'),...
                            'String', 'Tower',...
                            'Value', 0,...
                            'Callback', {@plotSiteTypes,2});

hSiteStatusText  = uicontrol(...
                   'parent', hpanel1, ...
                   'Style', 'Text', ...
                   'Units', 'normalized', ...
                   'Position', [.05 .48 .9 .35], ...
                   'String', {['Sites = ' num2str(network_information.all_RAN.sites)];['Owned roof-top = ' num2str(network_information.all_RAN.sites_owned_rooftops)];['Rented roof-top = ' num2str(network_information.all_RAN.sites_rent_rooftops)];...
                                ['Shared roof-top = ' num2str(network_information.all_RAN.sites_shared_rent_rooftops)];['Owned tower = ' num2str(network_information.all_RAN.sites_owned_towers)]; ['Rented tower = ' num2str(network_information.all_RAN.sites_rent_towers)];...
                                ['Shared tower = ' num2str(network_information.all_RAN.sites_shared_rent_towers)]}, ...
                   'HorizontalAlignment', 'Left', ...
                   'Tag', 'StatusTextTag');

                  
hBTScheckbox = uicontrol(...
                        'Parent',hpanel1,...
                        'Style', 'checkbox',...
                        'Units', 'normalized',...
                        'Position', [.015 .37 .45 .05],...
                        'TooltipString', 'Show GERAN',...
                        'String', 'BTS',...
                        'Value', 0,...
                        'Callback', {@plotBStype,1});
                    
hNodeBcheckbox = uicontrol(...
                        'Parent',hpanel1,...
                        'Style', 'checkbox',...
                        'Units', 'normalized',...
                        'Position', [.5 .37 .45 .05],...
                        'TooltipString', 'Show UTRAN',...
                        'String', 'NodeB',...
                        'Value', 0,...
                        'Callback', {@plotBStype,2}); 
                    
heNodeBcheckbox = uicontrol(...
                        'Parent',hpanel1,...
                        'Style', 'checkbox',...
                        'Units', 'normalized',...
                        'Position', [.015 .32 .45 .05],...
                        'TooltipString', 'Show EUTRAN',...
                        'String', 'eNodeB',...
                        'Value', 0,...
                        'Callback', {@plotBStype,3});
                    
heNodeBCAcheckbox = uicontrol(...
                        'Parent',hpanel1,...
                        'Style', 'checkbox',...
                        'Units', 'normalized',...
                        'Position', [.5 .32 .45 .05],...
                        'TooltipString', 'Show EUTRAN with Carrier Aggregation',...
                        'String', 'eNB_CA',...
                        'Value', 0,...
                        'Callback', {@plotBStype,4});       
 
            
 hRANStatusText  = uicontrol(...
               'parent', hpanel1, ...
               'Style', 'Text', ...
               'Units', 'normalized', ...
               'Position', [.05 0 .9 .3], ...
               'String', {['Cells = ' num2str(network_information.all_RAN.cells)];['Base stations = ' num2str(network_information.all_RAN.basestations)];['BTS = ' num2str(network_information.GERAN_900.basestations+network_information.GERAN_1800.basestations)];...
                            ['NodeB = ' num2str(network_information.UTRAN_2100.basestations+network_information.UTRAN_900.basestations)];['eNodeB = ' num2str(network_information.EUTRAN_s.basestations)]; ['eNodeB with CA = ' num2str(network_information.EUTRAN_CA.basestations)]}, ...
               'HorizontalAlignment', 'Left', ...
               'Tag', 'StatusTextTag');          
             

                    
% panel_2: costs
hpanel2 = uipanel(...
                'parent',hMainFigure,...
                'Title','Short Run Cost Results',...
                'Units', 'normalized', ...
                'Position',[0.136 0.84 0.12 0.15]); 
         
                    
hShowNetInfo_togglebutton = uicontrol(...
                                'parent',hpanel2,...
                                'Style','pushbutton',...
                                'TooltipString', 'Click here to see network cost information',...
                                'String','Network cost information',...
                                'Value',0,...
                                'Units','normalized',...
                                'Position',[0 0.74 1 0.25],...
                                'Callback',@plotNetworkSRcostInformation);
 
% axis
ahsouthwest = axes(...
            'Parent',hMainFigure,...
            'Units', 'normalized', ...
            'HandleVisibility','on', ...
            'Visible','off',...
            'Box','On',...
            'XTick', [],...
            'YTick', [],...
            'Position',[0.01 0.01 0.25 0.4]);  
        
hShowSiteInfo_togglebutton = uicontrol(...
                                'parent',hpanel2,...
                                'Style','togglebutton',...
                                'TooltipString', 'Click here and choose a site to access information',...
                                'String','Site cost information',...
                                'Value',0,...
                                'Units','normalized',...
                                'Position',[0 0.5 1 0.25],...
                                'Callback',@togglebutton_SiteInformation);                           

                            
hp2popup = uicontrol('Parent', hpanel2, ...
                    'Style','text',...
                    'String', 'Select figure',...
                    'Units','normalized',...
                    'Position',[0 0.3 1 0.2]);
                 
hp2popup = uicontrol('Parent', hpanel2, ...
                     'Style','popupmenu',...
                     'String', {'','Total operating cost','Unit cost curves','Energy Consumption','Cost per GB and GB per data user (in DL)'},...
                     'Units','normalized',...
                     'Position',[0 0.1 1 0.2],...
                     'Callback',@plotNetworkSRcostFigures);                            

% panel_3: Demand
hpanel3 = uipanel(...
                'parent',hMainFigure,...
                'Title','Demand - Revenue Results',...
                'Units', 'normalized', ...
                'Position',[0.136 0.72 0.12 0.1]); 
                            
hp3popup = uicontrol('Parent', hpanel3, ...
                    'Style','text',...
                    'String', 'Select figure',...
                    'Units','normalized',...
                    'Position',[0 0.6 1 0.3]);
                 
hp3popup = uicontrol('Parent', hpanel3, ...
                     'Style','popupmenu',...
                     'String', {'','Market Demand 1','Market Demand 2','Mobile data traffic forecast','Market demand forecast',...
                                'Annual market revenue','Market marginal analysis (2020)'},...
                     'Units','normalized',...
                     'Position',[0 0.2 1 0.3],...
                     'Callback',@plotDemandFigures);                  
                
% panel_4: Profits
hpanel4 = uipanel(...
                'parent',hMainFigure,...
                'Title','Profitability Results',...
                'BorderType','etchedout',...
                'BorderWidth',3,...
                'Units', 'normalized', ...
                'Position',[0.136 0.6 0.12 0.1]); 
                           
hp4popup = uicontrol('Parent', hpanel4, ...
                    'Style','text',...
                    'String', 'Select figure',...
                    'Units','normalized',...
                    'Position',[0 0.6 1 0.3]);
                 
hp4popup = uicontrol('Parent', hpanel4, ...
                     'Style','popupmenu',...
                     'String', {'','Annual traffic for operator','Profits for operator'},...
                     'Units','normalized',...
                     'Position',[0 0.2 1 0.3],...
                     'Callback',@plotProfitFigures);                    

                  
%panel_5: slider
panel_slider = uipanel(...
                'parent',hMainFigure,...
                'Title','Mobile data traffic growth',...
                'Units', 'normalized', ...
                'Position',[0.3 0.01 0.4 0.15]); 

% slider
sh = uicontrol('Parent',panel_slider,...
               'Style','slider',...
               'Tag','slider_demand_growth',...
               'Min',1,...
               'Max',length(network_throughput_progression.all_RAN.traffic_increase),...
               'Value',1,...
               'SliderStep', [1/(length(network_throughput_progression.all_RAN.traffic_increase)-1) 100/(length(network_throughput_progression.all_RAN.traffic_increase)-1)], ...
               'Units','normalized',....
               'Position',[0.05 0.35 0.55 0.3],...
               'UserData',struct('index',1,'diffMax',1),...
               'Callback',@demand_slider);

% static text
counter = 0;
sth = uicontrol('Parent',panel_slider,...
                'Style','text',...
                'String',['x' num2str(counter,'%.2f')],...
                'Units','normalized',...
                'Position',[0.6 0.3 0.1 0.3]);

%push button
pushbutton_slider = uicontrol('Parent',panel_slider,...
                    'Style','pushbutton',...
                    'Tag','push_button_in_slider',...
                    'String','Long-Run Network',...
                    'Units','normalized',...
                    'Visible','on',...
                    'Position',[0.73 0.1 0.25 0.9],....
                    'Callback',@pushbutton_demand_growth);

% panel_in_slider: costs
hpanel2_LR = uipanel(...
                'parent',panel_slider,...
                'Tag','panel_LR_in_slider',...
                'Title','Long Run Cost Results',...
                'Visible','off',...
                'Units', 'normalized', ...
                'Position',[0.73 0.1 0.25 0.9]); 
         
                    
hShowNetInfo_togglebutton_LR = uicontrol(...
                                'parent',hpanel2_LR,...
                                'Style','pushbutton',...
                                'TooltipString', 'Click here to see network cost information',...
                                'String','Network',...
                                'Value',0,...
                                'Units','normalized',...
                                'Position',[0.01 0.5 0.48 0.5],...
                                'Callback',@plotNetworkLRcostInformation);
 
% axis
ahsoutheast = axes(...
            'Parent',hMainFigure,...
            'Units', 'normalized', ...
            'HandleVisibility','on', ...
            'Visible','off',...
            'Box','On',...
            'XTick', [],...
            'YTick', [],...
            'Position',[0.72 0.01 0.25 0.4]);  
        
hShowSiteInfo_togglebutton_LR = uicontrol(...
                                'parent',hpanel2_LR,...
                                'Style','togglebutton',...
                                'TooltipString', 'Click here and choose a site to access information',...
                                'String','Site',...
                                'Value',0,...
                                'Units','normalized',...
                                'Position',[0.51 0.5 0.48 0.5],...
                                'Callback',@togglebutton_SiteInformation_LR);                           

                                        
hp2popup = uicontrol('Parent', hpanel2_LR, ...
                     'Style','popupmenu',...
                     'String', {'','Investments','Total operating cost','Unit cost curves','Energy Consumption','Cost per GB and GB per data user (in DL)'},...
                     'Units','normalized',...
                     'Position',[0 0.08 1 0.4],...
                     'Callback',@plotNetworkLRcostFigures);              
            
            
            
            
% panel_6: table:
hpanel_right = uipanel(...
                'parent',hMainFigure,...
                'Title','',...
                'Units', 'normalized', ...
                'Position',[0.72 0.45 0.248 0.54]); 
            
% table
hp3table = uitable(...
                 'Parent', hpanel_right,...
                 'Units', 'normalized',...
                 'Position', [0 0 1 1],...
                 'BackgroundColor',[1 1 1],...
                 'RowStriping','on',...
                 'ForegroundColor','k',...
                 'Fontname','Arial',...
                 'FontSize',8,...
                 'FontWeight','bold',...
                 'Enable','off',...
                 'ColumnName', table_p3_headers,...
                 'ColumnFormat', table_p3_colFormat,...
                 'ColumnWidth', table_p3_columnwidth,...
                 'RowName', [],...
                 'Data',  table_p3_data);
             
 
%push button
pushbutton_table = uicontrol('Parent',hpanel_right,...
                    'Style','pushbutton',...
                    'Enable','off',...
                    'Tag','push_button_in_table',...
                    'String','Update table',...
                    'Units','normalized',...
                    'Visible','on',...
                    'Position',[0.3 0.01 0.4 0.065],....
                    'Callback',@update_LRtable);
                
%**************************************************************************
% Initialization tasks - phase 2
%**************************************************************************

%Make the GUI visible.
set(hMainFigure,'Visible','on'); 
   
%The GUI has not changed
guidirty(hMainFigure,false);

% Plot the sites
plotDefaultSites();       

setappdata(0, 'traffic_growth_snapshot_index', 1);

%**************************************************************************
% Callbacks for TERAN
%**************************************************************************
function resizeui(hObject,callbackdata)
end

function programQuit(hObject,callbackdata)
    if getappdata(hObject,'Dirty')
        savefile = questdlg(['You are about to close ' get(hObject,'Name') '. Save before closing it?'], get(hObject,'Name'),'Save','Close without saving it','Cancel','Cancel');
        if strcmp(savefile,'Save')
             %SaveMenuitem (hMainFigure,callbackdata);
        end
        if strcmp(savefile,'Cancel')
            return;
        end
        if strcmp(savefile,'Close without saving it')
            delete(hObject);
        end
    else
        selection = questdlg(['You are about to close ' get(hObject,'Name') '. Are you sure you want to continue?'], get(hObject,'Name'),'Yes','No','No');
        if strcmp(selection,'Yes')
            delete(hObject);
        end
    end
end

function importFILE(hObject,callbackdata)
    display('here we need the read mfile');
end

function exportFILE(hObject,callbackdata)
    display('here we need the write mfile');
end

function add_site(hObject,callbackdata)
    display('here we need to add a site');
end

function plotSiteTypes(hObject,callbackdata,type)
    
    sitetype = {'Rooftop', 'Tower'};
    sitename = sitetype{type};
    site_types_name = {inputs_technology.site_types.name};
    set(ah, 'NextPlot', 'Add')
    switch type
        case 1 
            if get(hObject, 'Value') 
                index_type1 = find(strcmp({site_infrastructure.site_type},site_types_name{2}));
                index_type2 = find(strcmp({site_infrastructure.site_type},site_types_name{4}));
                index_type3 = find(strcmp({site_infrastructure.site_type},site_types_name{6}));
                plot(ah,sites_x(index_type1),sites_y(index_type1),['o' 'b'],'DisplayName', sitename,'linewidth',1.5,'MarkerSize',11);
                plot(ah,sites_x(index_type2),sites_y(index_type2),['o' 'r'],'DisplayName', sitename,'linewidth',1.5,'MarkerSize',11);
                plot(ah,sites_x(index_type3),sites_y(index_type3),['o' 'g'],'DisplayName', sitename,'linewidth',1.5,'MarkerSize',11);
            else
              delete(findobj(ah, 'DisplayName', sitename))
            end
            
        case 2 
             if get(hObject, 'Value') 
                index_type1 = find(strcmp({site_infrastructure.site_type},site_types_name{1}));
                index_type2 = find(strcmp({site_infrastructure.site_type},site_types_name{3}));
                index_type3 = find(strcmp({site_infrastructure.site_type},site_types_name{5}));
                plot(ah,sites_x(index_type1),sites_y(index_type1),['^' 'b'],'DisplayName', sitename,'linewidth',2.5,'MarkerSize',12);
                plot(ah,sites_x(index_type2),sites_y(index_type2),['^' 'r'],'DisplayName', sitename,'linewidth',2.5,'MarkerSize',12);
                plot(ah,sites_x(index_type3),sites_y(index_type3),['^' 'g'],'DisplayName', sitename,'linewidth',2.5,'MarkerSize',12);
             else
              delete(findobj(ah, 'DisplayName', sitename))
             end
    end
end

function plotBStype(hObject,callbackdata,BS_type)
    
    BStype = {'BTS', 'nodeB','enodeB','enodeB CA'};
    BSname = BStype{BS_type};
    index_EUTRAN_s = find(network_information.EUTRAN_s.cells_per_site>0);
    index_EUTRAN_CA = find(network_information.EUTRAN_CA.cells_per_site>0);
    index_UTRAN = union(find(network_information.UTRAN_2100.cells_per_site>0),find(network_information.UTRAN_900.cells_per_site>0));
    index_GERAN = union(find(network_information.GERAN_900.cells_per_site>0),find(network_information.GERAN_1800.cells_per_site>0));
    set(ah, 'NextPlot', 'Add')
    switch BS_type
        case 1 
            if get(hObject, 'Value')               
                plot(ah,sites_x(index_GERAN),sites_y(index_GERAN),'.','MarkerSize',6,'MarkerEdgeColor','c','DisplayName', BSname);  
            else
              delete(findobj(ah, 'DisplayName', BSname))
            end
            
        case 2 
             if get(hObject, 'Value') 
                plot(ah,sites_x(index_UTRAN),sites_y(index_UTRAN),'s','MarkerSize',4,'MarkerEdgeColor','k','DisplayName', BSname);
             else
              delete(findobj(ah, 'DisplayName', BSname))
             end
             
        case 3 
             if get(hObject, 'Value') 
                plot(ah,sites_x(index_EUTRAN_s),sites_y(index_EUTRAN_s),'s','MarkerSize',6,'MarkerEdgeColor','m','DisplayName', BSname);
             else
              delete(findobj(ah, 'DisplayName', BSname))
             end

        case 4 
             if get(hObject, 'Value') 
                plot(ah,sites_x(index_EUTRAN_CA),sites_y(index_EUTRAN_CA),'s','MarkerSize',6,'MarkerEdgeColor','r','DisplayName', BSname);
             else
              delete(findobj(ah, 'DisplayName', BSname))
             end             
    end
end

function PlotRANpopupmenu(hObject,callbackdata)
   
    val = get(hObject,'Value');
    string_list = get(hObject,'String');
    RANconfSites = string_list{val};
    index = [];
    indexant = [];
    cla(ah);
    set(hRooftopcheckbox,'Value',0);
    set(hTowercheckbox,'Value',0);
    set(hBTScheckbox,'Value',0);
    set(hNodeBcheckbox,'Value',0);
    set(heNodeBcheckbox,'Value',0);
    set(heNodeBCAcheckbox,'Value',0);
    if val ~= 1
       
        for i=1:network_information.all_RAN.sites
            existRANconfigFlags = strcmp(site_infrastructure(i).configurations, RANconfSites);
            if sum(existRANconfigFlags)>0
                index = [index i*ones(1,sum(existRANconfigFlags))];
                indexant = [indexant [site_infrastructure(i).cell_directions{existRANconfigFlags}]];
            end
        end
        
        offset = max(area(2)- area(1), area(4)- area(3))/50;
        hold(ah,'on');
        hpran1 = plot(ah,[sites_x(index); sites_x(index)+offset*cos((90-indexant)*pi/180)], [sites_y(index); sites_y(index)+offset*sin((90-indexant)*pi/180)],'>','MarkerSize',4,'MarkerEdgeColor','g','MarkerFaceColor','g','LineWidth', 2,'color', 'g', 'LineStyle','-');    
        hpran1 = plot(ah,sites_x(index),sites_y(index),'s','MarkerEdgeColor',[0.4,0.4,0.4],'MarkerSize',5,'MarkerEdgeColor','b','MarkerFaceColor','b','DisplayName', RANconfSites);
        axis(ah,area*resolution);
        hold(ah,'off');
    else
        plotDefaultSites()
    end
    
     
end

function togglebutton_SiteInformation(hObject,callbackdata)
    button_state = get(hObject,'Value');   
    dcm_obj = datacursormode(hMainFigure);
    if button_state == get(hObject,'Max')
        set(hObject,'TooltipString','select now a site for information');
        datacursormode on;
        set(dcm_obj,'UpdateFcn', @datacursor );   
        set(dcm_obj,'DisplayStyle', 'window' ); 
    elseif button_state == get(hObject,'Min')
        set(hObject,'TooltipString','Click here and choose a site to access information');
        datacursormode off;
        cla(ahsouthwest,'reset');
        set(ahsouthwest,'Visible','off');
    end
          
end  
    
function plotNetworkSRcostFigures(hObject,eventdata)
    
    strmenu = get(hObject,'String');
    val = get(hObject,'Value');
 
    f = figure(...
            'Color', [0.8 0.8 0.8], ...
            'Visible','off',...
            'Units','normalized',...
            'Position',[0.15,0.15,0.8,0.8],...
            'Name',strmenu{val},...
            'NumberTitle','off',...
            'Resize','on',...
            'MenuBar', 'figure',...
            'Toolbar','none');  
        
    movegui(f,'center');
    
    fah = axes(...
            'Parent',f,...
            'Units', 'normalized', ...
            'Position',[0.1 0.1 0.8 0.8]);         
       
    switch strmenu{val};
        case 'Total operating cost' 
            set(f,'Visible','on'); hold on;           
            plot(fah,SR_MobileDataTraffic_TB_mon,OPEX_total/1000,'k','linewidth',3); 
            plot(fah,[network_throughput_regional_TB_mon network_throughput_regional_TB_mon], [0 (OPEX_total(end)/1000+(OPEX_total(end)/1000-OPEX_total(1)/1000)*0.2)],'k:');        
            set(fah,'FontSize',20);
            axis([0 Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon*1.1 (OPEX_total(1)/1000-(OPEX_total(end)/1000-OPEX_total(1)/1000)*0.2) (OPEX_total(end)/1000+(OPEX_total(end)/1000-OPEX_total(1)/1000)*0.2)]);
            f1L = get(fah,'yLim');
            set(fah,'ytick',linspace(f1L(1),f1L(2),6));
            set(fah,'yTickLabel',num2str(get(fah,'ytick').','%.2f'));
            xlabel('Data Traffic (TB/month)');
            ylabel('thousand EUR/month');
            legend('Total (operating) cost','Current data traffic volume','Orientation','vertical', 'location','northwest');
            title(['Region ' num2str(inputs_market_industry.demographics.land_Area_km2) ' km^{2}']);
            text(0.55,0.885,{[num2str(actual_max_network_capacity_regional_DL_TB_mon,'%.0f'),' TB/mon is the actual DL network capacity']; ...
                [num2str(Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon,'%.0f'),' TB/mon is the max throughput with even traffic distribution'];...
                [num2str(Max_Traffic_to_be_satisfied_regional_TB_mon,'%.0f'),' TB/mon is the max throughput with even traffic distribution and capacity load ceiling'];...
                [num2str(network_throughput_regional_TB_mon,'%.0f'),' TB/mon is the current throughput']},'units','normalized');
            hold off;
        case 'Unit cost curves' 
            set(f,'Visible','on'); hold on;
            plot(fah,SR_MobileDataTraffic_TB_mon,Average_Total_Cost/1000,'m','linewidth',3);
            plot(fah,SR_MobileDataTraffic_TB_mon,Average_Fixed_Cost/1000,'b--','linewidth',2);
            plot(fah,SR_MobileDataTraffic_TB_mon,Average_Variable_Cost/1000,'g','linewidth',3);
            plot(fah,SR_MobileDataTraffic_TB_mon,Marginal_Cost/1000,'r--','linewidth',2);
            plot(fah,[network_throughput_regional_TB_mon network_throughput_regional_TB_mon], [0 5],'k:');
            set(fah,'FontSize',20);
            axis([2 Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon*1.1 0 5]);
            f2L = get(fah,'yLim');
            set(fah,'ytick',linspace(f2L(1),f2L(2),6));
            set(fah,'yTickLabel',num2str(get(fah,'ytick').','%.2f'));
            xlabel('Data Traffic (TB/month)');
            ylabel('thousand EUR/TB');
            legend('Average Total Cost','Average Fixed Cost','Average Variable Cost','Marginal cost');
            title('Unit cost curves');
            text(SR_MobileDataTraffic_TB_mon(end),Average_Total_Cost(end)/1000,num2str(Average_Total_Cost(end)/1000),'Color','m');
            text(SR_MobileDataTraffic_TB_mon(end),-0.05,num2str(Marginal_Cost(end)/1000),'Color','r');
            text(0.3,0.585,{'At the current traffic level:';...
                [num2str(Average_Total_Cost(current_point)/1024,'%.4f'),' EUR per GB/mon is the Average Total Cost']; ...
                [num2str(Average_Fixed_Cost(current_point)/1024,'%.4f'),' EUR per GB/mon is the Average Fixed Cost'];...
                [num2str(Average_Variable_Cost(current_point)/1024,'%.4f'),' EUR per GB/mon is the Average Variable Cost'];...
                [num2str(Marginal_Cost(current_point)/1024,'%.4f'),' EUR for one additional GB/mon is the Marginal Cost']},'units','normalized');
            hold off;
        case 'Energy Consumption' 
            set(f,'Visible','on'); hold on;
            plot(fah,SR_MobileDataTraffic_TB_mon, Efix_net*ones(1,length(SR_MobileDataTraffic_TB_mon)),'r','linewidth',3);
            plot(fah,SR_MobileDataTraffic_TB_mon,Evar_net,'b','linewidth',3);
            plot(fah,SR_MobileDataTraffic_TB_mon, (Efix_net*ones(1,length(SR_MobileDataTraffic_TB_mon))+Evar_net),'k','linewidth',3);
            plot(fah,[network_throughput_regional_TB_mon network_throughput_regional_TB_mon], [0 ((Efix_net+Evar_net(end))*1.1)],'k:');
            set(fah,'FontSize',20);
            axis([0 Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon*1.1 0 ((Efix_net+Evar_net(end))*1.1)]);
            L = get(fah,'yLim');
            set(fah,'ytick',linspace(L(1),L(2),6));
            set(fah,'yTickLabel',num2str(get(fah,'ytick').','%.2f'));
            xlabel('Data Traffic (TB/month)'); 
            ylabel('Energy (MWh/month)');
            legend('Fixed','Variable','Total','Orientation','horizontal','location','northwest');
            title('Energy Consumption');
            text(0.3,0.585,{'At the current traffic level:';...
                [num2str(Efix_net,'%.4f'),' MWh/month is the Fixed energy consumption']; ...
                [num2str(Evar_net(current_point),'%.4f'),' MWh/month is the Variable energy consumption'];...
                [num2str(Efix_net+Evar_net(current_point),'%.4f'),' MWh/month is the Total energy consumption']},'units','normalized');
            hold off;
        case 'Cost per GB and GB per data user (in DL)'
            set(f,'Visible','on');hold on;
            plot(fah,[network_throughput_regional_TB_mon network_throughput_regional_TB_mon], [0 10],'k:');
            [hAx,hLine1,hLine2] = plotyy(fah,SR_MobileDataTraffic_TB_mon,Average_Total_Cost_of_GB,SR_MobileDataTraffic_TB_mon,Average_user_data);
            set(hLine1,'LineWidth',2,'Color','b');
            set(hLine2,'LineWidth',3,'Color','r');
            set(hAx,{'ycolor'},{'b';'r'}) 
            set(hAx(1),'FontSize',20);
            set(hAx(2),'FontSize',20);
            set(hAx(1),'box','off');
            set(hAx(1),'ylim',[0, 10]);
            L = get(hAx(1),'yLim');
            R = get(hAx(2),'yLim');
            set(hAx(1),'ytick',linspace(L(1),L(2),6));
            set(hAx(1),'yTickLabel',num2str(get(hAx(1),'ytick').','%.2f'));
            set(hAx(2),'ytick',linspace(R(1),R(2),6));
            set(hAx(2),'yTickLabel',num2str(get(hAx(2),'ytick').','%.2f'));
            set(hAx(1),'xlim',[0, Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon*1.1 ]);
            set(hAx(2),'xlim',[0, Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon*1.1 ]);
            xlabel('Data Traffic (TB/month)');
            ylabel(hAx(1),'Cost per GB (EUR/GB)');
            ylabel(hAx(2),'Data usage per user (GB/month)');
            title('Cost per GB and GB per data user');
            text(SR_MobileDataTraffic_TB_mon(end),Average_Total_Cost_of_GB(end),num2str(Average_Total_Cost_of_GB(end)),'Color','b','parent',hAx(1));
            text(SR_MobileDataTraffic_TB_mon(end),Average_user_data(end),num2str(Average_user_data(end)),'Color','r','parent',hAx(2));  
            text(0.3,0.585,{'At the current traffic level:';...
                [num2str(Average_Total_Cost_of_GB(current_point),'%.4f'),' EUR/GB'];...
                [num2str(Average_user_data(current_point),'%.4f'),' GB/month is the average user data rate']},'units','normalized');
            hold off;
        otherwise
            %do nothing
    end
end

function plotDemandFigures(hObject,eventdata)
    strmenu = get(hObject,'String');
    val = get(hObject,'Value');
 
    f = figure(...
            'Color', [0.8 0.8 0.8], ...
            'Visible','off',...
            'Units','normalized',...
            'Position',[0.15,0.15,0.8,0.8],...
            'Name',strmenu{val},...
            'NumberTitle','off',...
            'Resize','on',...
            'MenuBar', 'figure',...
            'Toolbar','none');  
        
    movegui(f,'center');
    
    fah = axes(...
            'Parent',f,...
            'Units', 'normalized', ...
            'Position',[0.1 0.1 0.8 0.8]);         
       
    switch strmenu{val};
        case 'Market Demand 1'  % Market Demand curve when only price affects the demand     
            Q = inputs_demand_parameters.quantity;
            P = inputs_demand_parameters.determinants_of_demand.price;
            Pest = exp(market_demand_revenues.inverse_demand_simple_2007_2016.price_log);
            
            set(f,'Visible','on'); hold on;                  
            plot(Q/1024/1024, P, 'd','MarkerSize', 10, 'LineWidth', 2,'MarkerEdgeColor','k','MarkerFaceColor','white'); 
            plot(Q/1024/1024, Pest, 'k', 'LineWidth', 3);
            set(gca,'FontSize',20);
            xlabel('Quantity Q (PB/month)');
            ylabel('Price P (EURO per GB/month)');
            legend('Market Equilibria', 'Demand Curve','Location','southwest');
            title('Market Demand of data traffic (if the price alone determines the demand)')
            set(gca,'xscale','log');
            set(gca,'yscale','log');
            set(gca,'xLim',[0.8*Q(1) 1.5*Q(end)]/1024/1024)
            set(gca,'xTick',sort(Q)/1024/1024)
            set(gca, 'XTickLabel', num2str(get(gca,'xTick')','%0.2f'));
            set(gca,'yLim',[0 300])
            set(gca,'yTick',sort(P))
            set(gca, 'YTickLabel', num2str(get(gca,'yTick')','%0.1f'));
            set(gca, 'Ticklength', [0 0])
            for i=1:length(Q)
                text(1.2*Q(i)/1024/1024,1.2*P(i),['\fontsize{14}\color{black}' num2str(2006+i)]);
            end
            % gridlines 
            g_y=[0.5 sort(P) 300]; % A zero value in log scale is problematic
            g_x=[0.5*Q(1)/1024/1024 sort(Q)/1024/1024 2*Q(end)/1024/1024]; 
            semilogx([g_x(:) g_x(:)],[g_y(1) g_y(end)],'k:');
            semilogx([g_x(1) g_x(end)],[g_y(:) g_y(:)],'k:');
            hold off;
        case 'Market Demand 2'  % Market Demand curve when price and generations affect the demand
            Q = inputs_demand_parameters.quantity;
            P = inputs_demand_parameters.determinants_of_demand.price;
            Pest = exp(market_demand_revenues.inverse_demand_simple_2007_2016.price_log);         
            Q3G = exp(market_demand_revenues.inverse_demand_multiple_3G_2007_2011.quantity_log);
            P3Gest = exp(market_demand_revenues.inverse_demand_multiple_3G_2007_2011.price_log);         
            Q4G = exp(market_demand_revenues.inverse_demand_multiple_4G_2012_2016.quantity_log);
            P4Gest = exp(market_demand_revenues.inverse_demand_multiple_4G_2012_2016.price_log);  
            
            set(f,'Visible','on'); hold on;
            plot(Q/1024/1024, P, 'd','MarkerSize', 10, 'LineWidth', 2,'MarkerEdgeColor','k','MarkerFaceColor','white'); 
            plot(Q/1024/1024, Pest, 'k', 'LineWidth', 3);
            plot(Q3G/1024/1024, P3Gest, 'b', 'LineWidth', 5); 
            plot(Q4G/1024/1024, P4Gest, 'r', 'LineWidth', 5); 
            set(gca,'FontSize',20);
            xlabel('Quantity Q (PB/month)');
            ylabel('Price P (EURO per GB/month)');
            legend('Market Equilibria', 'Regression Line 2007-2015', '3G Demand Curve', '4G Demand Curve', 'Location','southwest');
            title('Market Demand of data traffic (if the price and experienced data rate factor determine the demand)');
            set(gca,'xscale','log');
            set(gca,'yscale','log');
            set(gca,'xLim',[0.8*Q(1) 1.5*Q(end)]/1024/1024)
            set(gca,'xTick',sort(Q)/1024/1024)
            set(gca, 'XTickLabel', num2str(get(gca,'xTick')','%0.2f'));
            set(gca,'yLim',[0 300])
            set(gca,'yTick',sort(P))
            set(gca, 'YTickLabel', num2str(get(gca,'yTick')','%0.1f'));
            set(gca, 'Ticklength', [0 0])
            for i=1:length(Q)
                text(1.2*Q(i)/1024/1024,1.2*P(i),['\fontsize{14}\color{black}' num2str(2006+i)]);
            end
            % gridlines 
            g_y=[0.5 sort(P) 300]; % A zero value in log scale is problematic
            g_x=[0.5*Q(1)/1024/1024 sort(Q)/1024/1024 2*Q(end)/1024/1024]; 
            semilogx([g_x(:) g_x(:)],[g_y(1) g_y(end)],'k:');
            semilogx([g_x(1) g_x(end)],[g_y(:) g_y(:)],'k:');
            hold off;
        case 'Mobile data traffic forecast' %Mobile data traffic forecast
            Q = inputs_demand_parameters.quantity;
            MDfit_x = market_demand_revenues.traffic_fit.T;
            MDg_x = market_demand_revenues.traffic_forecast_geometric.T;
            MDe_x = market_demand_revenues.traffic_forecast_exponential.T;
            MDp_x = market_demand_revenues.traffic_forecast_power.T;
            MDfit_y = market_demand_revenues.traffic_fit.Y;
            MDg_y = market_demand_revenues.traffic_forecast_geometric.Y;
            MDe_y = market_demand_revenues.traffic_forecast_exponential.Y;
            MDp_y = market_demand_revenues.traffic_forecast_power.Y;
            MDg_cagr = market_demand_revenues.traffic_forecast_geometric.CAGR;
            MDe_cagr = market_demand_revenues.traffic_forecast_exponential.CAGR;
            MDp_cagr = market_demand_revenues.traffic_forecast_power.CAGR;
            
            set(f,'Visible','on'); hold on;
            plot(MDfit_x, MDfit_y/1024/1024, 'k', 'LineWidth', 3);
            plot(MDg_x, MDg_y/1024/1024, '--b' , 'LineWidth', 3);
            plot(MDe_x, MDe_y/1024/1024, '--r' , 'LineWidth', 3);
            plot(MDp_x, MDp_y/1024/1024, '--g' , 'LineWidth', 3);
            plot(MDg_x(end), MDg_y(end)/1024/1024, 'o' , 'LineWidth', 2,'MarkerSize', 12, 'MarkerEdgeColor', 'b');
            text(MDg_x(end)+0.1, MDg_y(end)/1024/1024, {['growth: x' num2str((MDg_y(end)/Q(end)),'%0.2f')]; ['CAGR: ' num2str(MDg_cagr*100,'%5.1f%%')]} , 'FontSize',12 );
            plot(MDe_x(end), MDe_y(end)/1024/1024, 'o' , 'LineWidth', 2,'MarkerSize', 12, 'MarkerEdgeColor', 'r');
            text(MDe_x(end)+0.1, MDe_y(end)/1024/1024, {['growth: x' num2str((MDe_y(end)/Q(end)),'%0.2f')]; ['CAGR: ' num2str(MDe_cagr*100,'%5.1f%%')]} , 'FontSize',12 );
            plot(MDp_x(end), MDp_y(end)/1024/1024, 'o' , 'LineWidth', 2,'MarkerSize', 12,'MarkerEdgeColor', 'g');
            text(MDp_x(end)+0.1, MDp_y(end)/1024/1024, {['growth: x' num2str((MDp_y(end)/Q(end)),'%0.2f')]; ['CAGR: ' num2str(MDp_cagr*100,'%5.1f%%')]} , 'FontSize',12 );
            plot(MDfit_x(end),MDfit_y(end)/1024/1024, 'd','MarkerSize', 12, 'LineWidth', 3,'MarkerEdgeColor','k','MarkerFaceColor','none'); 
            %set(gca,'XMinorTick','on')
            set(gca,'FontSize',20);
            set(gca,'Xtick',2012:2020)
            set(gca, 'XTickLabel', num2str(get(gca,'XTick')','%0.0f'));
            xlim([2012 2021]);
            xlabel('Year');
            ylabel('Mobile Data Traffic (PB/month)');
            legend('Mobile Data Traffic (past)','High Forecast scenario','Medium Forecast scenario','Low Forecast scenario','Orientation','vertical', 'location','northwest');
            title('Annual mobile data traffic forecast');
            hold off;
        case 'Market demand forecast'
            Qlog_2020 = market_demand_revenues.inverse_demand_forecast2020.quantity_log_2020;
            
            Plog_3G = market_demand_revenues.inverse_demand_multiple_3G_2007_2011.alfa*Qlog_2020+...
                market_demand_revenues.inverse_demand_multiple_3G_2007_2011.beta*log(inputs_demand_parameters.determinants_of_demand.experienced_user_data_rate_factor(1))+...
                market_demand_revenues.inverse_demand_multiple_3G_2007_2011.gama;
            Plog_4G = market_demand_revenues.inverse_demand_multiple_4G_2012_2016.alfa*Qlog_2020+...
                market_demand_revenues.inverse_demand_multiple_4G_2012_2016.beta*log(inputs_demand_parameters.determinants_of_demand.experienced_user_data_rate_factor(6))+...
                market_demand_revenues.inverse_demand_multiple_4G_2012_2016.gama;
            Plog_pro = market_demand_revenues.inverse_demand_forecast4Gpro.price_log_pro;
            Plog_2020 = market_demand_revenues.inverse_demand_forecast2020.price_log_2020;
            Qlog_est_now = log(market_demand_revenues.traffic_fit.Y(end));
            Plog_est_now = market_demand_revenues.inverse_demand_multiple_4G_2012_2016.alfa*Qlog_est_now+...
                market_demand_revenues.inverse_demand_multiple_4G_2012_2016.beta*log(inputs_demand_parameters.determinants_of_demand.experienced_user_data_rate_factor(6))+...
                market_demand_revenues.inverse_demand_multiple_4G_2012_2016.gama;
            Qlog_h_forecast = market_demand_revenues.inverse_demand_forecast2020.highSc_quantity_log_2020;
            Plog_h_forecast = market_demand_revenues.inverse_demand_forecast2020.highSc_price_log_2020;
            Qlog_m_forecast = market_demand_revenues.inverse_demand_forecast2020.mediumSc_quantity_log_2020;
            Plog_m_forecast = market_demand_revenues.inverse_demand_forecast2020.mediumSc_price_log_2020;
            Qlog_l_forecast = market_demand_revenues.inverse_demand_forecast2020.lowSc_quantity_log_2020;
            Plog_l_forecast = market_demand_revenues.inverse_demand_forecast2020.lowSc_price_log_2020;

            set(f,'Visible','on'); hold on;
            plot(exp(Qlog_2020)/1024/1024, exp(Plog_3G), 'b', 'LineWidth', 4); 
            plot(exp(Qlog_2020)/1024/1024, exp(Plog_4G), 'r', 'LineWidth', 4); 
            plot(exp(Qlog_2020)/1024/1024, exp(Plog_pro), 'm', 'LineWidth', 4); 
            plot(exp(Qlog_2020)/1024/1024, exp(Plog_2020), 'g', 'LineWidth', 4);
            plot(exp(Qlog_est_now)/1024/1024, exp(Plog_est_now), 'd','MarkerSize', 15, 'LineWidth', 3,'MarkerEdgeColor','k','MarkerFaceColor','none'); %2016 market equilibrium on 4G demand curve
            plot(exp(Qlog_h_forecast)/1024/1024, exp(Plog_h_forecast), 'o','MarkerSize', 15, 'LineWidth', 3,'MarkerEdgeColor','b'); %2020 High scenario market equilibrium
            plot(exp(Qlog_m_forecast)/1024/1024, exp(Plog_m_forecast), 'o','MarkerSize', 15, 'LineWidth', 3,'MarkerEdgeColor','r');  %2020 Medium scenario market equilibrium
            plot(exp(Qlog_l_forecast)/1024/1024,exp(Plog_l_forecast), 'o','MarkerSize', 15, 'LineWidth', 3,'MarkerEdgeColor','g');  %2020 Low scenario market equilibrium
            set(gca,'FontSize',20);
            xlabel('Quantity Q (PB/month)');
            ylabel('Price P (EURO per GB/month)');
            legend({'3G Demand (2007-2011)','4G Demand (2012-2016)','4Gpro Demand (2017-2019)','5G Demand (2020)','Equilibrium (2016 estimation)','High scenario equilibrium (2020)', 'Medium scenario equilibrium (2020)','Low scenario equilibrium (2020)'},'Location','Northeast','FontSize',14);
            title('Market demand evolution and possible market equilibria in 2020');
            set(gca,'xscale','log');
            set(gca,'yscale','log');
            set(gca,'xLim',[inputs_demand_parameters.quantity(end-2)/1024/1024 1.3*exp(Qlog_2020(end))/1024/1024])
            set(gca,'xTick',[exp(Qlog_est_now) exp(Qlog_l_forecast) exp(Qlog_m_forecast) exp(Qlog_h_forecast)]/1024/1024)
            set(gca, 'XTickLabel', num2str(get(gca,'xTick')','%0.0f'));
            set(gca,'yLim',[0.2 2])
            set(gca,'yTick',[exp(Plog_h_forecast) exp(Plog_m_forecast) exp(Plog_l_forecast) exp(Plog_est_now)])
            set(gca, 'YTickLabel', num2str(get(gca,'yTick')','%0.2f'));
            % gridlines 
            g_y=[0.2 exp(Plog_h_forecast) exp(Plog_m_forecast) exp(Plog_l_forecast) exp(Plog_est_now) 2]; % A zero value in log scale is problematic
            g_x=[inputs_demand_parameters.quantity(end-2) exp(Qlog_est_now) exp(Qlog_l_forecast) exp(Qlog_m_forecast) exp(Qlog_h_forecast) 1.3*exp(Qlog_2020(end))]/1024/1024; 
            semilogx([g_x(:) g_x(:)],[g_y(1) g_y(end)],'k:');
            semilogx([g_x(1) g_x(end)],[g_y(:) g_y(:)],'k:');
            set(gca, 'Ticklength', [0 0])
            hold off;
        case 'Annual market revenue'   %Revenues (annually) in bars
            TR_past_est = market_demand_revenues.annual_revenue;
            TR_l_est_past = market_demand_revenues.annual_revenue_low; 
            TR_m_est_past = market_demand_revenues.annual_revenue_medium;
            TR_h_est_past = market_demand_revenues.annual_revenue_high;

            TRbar = [TR_l_est_past; TR_m_est_past; TR_h_est_past];
            TRbar1 = [TRbar(:,1)';TRbar(:,2)';TRbar(:,3)';TRbar(:,4)'];

            CAGR3_TR = (TR_l_est_past(end)/TR_past_est(end))^(1/length(TR_l_est_past))-1;
            CAGR1_TR = (TR_m_est_past(end)/TR_past_est(end))^(1/length(TR_m_est_past))-1;
            CAGR2_TR = (TR_h_est_past(end)/TR_past_est(end))^(1/length(TR_h_est_past))-1;

            set(f,'Visible','on'); hold on;
            p1 = bar(2010:2016,TR_past_est(4:end));
            p2 = bar(2017:2020,TRbar1);
            plot([2019 2020], [TR_h_est_past(end) TR_h_est_past(end)], 'k','LineWidth', 2);
            text(2018, TR_h_est_past(end), {['growth: x' num2str((TR_h_est_past(end)/TR_past_est(end)),'%0.2f')]; ['CAGR: ' num2str(CAGR2_TR*100,'%5.1f%%')]} , 'FontSize',12 );
            plot([2019 2019.8],[TR_m_est_past(end) TR_m_est_past(end)], 'k','LineWidth', 2);
            text(2018, TR_m_est_past(end), {['growth: x' num2str((TR_m_est_past(end)/TR_past_est(end)),'%0.2f')]; ['CAGR: ' num2str(CAGR1_TR*100,'%5.1f%%')]} , 'FontSize',12 );
            plot([2019 2019.6], [TR_l_est_past(end) TR_l_est_past(end)], 'k','LineWidth', 2');
            text(2018, TR_l_est_past(end), {['growth: x' num2str((TR_l_est_past(end)/TR_past_est(end)),'%0.2f')]; ['CAGR: ' num2str(CAGR3_TR*100,'%5.1f%%')]} , 'FontSize',12 );
            set(p1,'Facecolor','k');
            set(gca,'FontSize',20);
            set(gca,'Xtick',2010:2020);
            set(gca, 'XTickLabel', num2str(get(gca,'XTick')','%0.0f'));
            xlim([2009 2021]);
            xlabel('Year');
            ylabel('EURO per year');
            legend('Past (estimation)','Low forecast scenario','Medium forecast scenario', 'High forecast scenario','Location','Northwest');
            hold off;
         case 'Market marginal analysis (2020)'
            
            P_2016_est_current = exp(market_demand_revenues.inverse_demand.year_0.total.estimation.price_log_resolution(end)); 
            Q_2016_current = exp(market_demand_revenues.inverse_demand.year_0.total.estimation.quantity_log_resolution(end)); 
            Q_2016_resolution_l = exp(market_demand_revenues.inverse_demand.year_0.total.estimation.quantity_log_resolution_long);
            P_2016_resolution_l = exp(market_demand_revenues.inverse_demand.year_0.total.estimation.price_log_resolution_long); 
            MR_2016_resolution_l = market_demand_revenues.inverse_demand.year_0.total.estimation.marginal_revenue_resolution_long;
            MR_2016_current = market_demand_revenues.inverse_demand.year_0.total.estimation.marginal_revenue_resolution(end);
           
            scenario = 'medium';
            P_2020_forecast = exp(market_demand_revenues.inverse_demand.year_4.total.(scenario).price_log_resolution(end)); 
            Q_2020_forecast = exp(market_demand_revenues.inverse_demand.year_4.total.(scenario).quantity_log_resolution(end)); 
            Q_2020_resolution_l = exp(market_demand_revenues.inverse_demand.year_4.total.(scenario).quantity_log_resolution_long);
            P_2020_resolution_l = exp(market_demand_revenues.inverse_demand.year_4.total.(scenario).price_log_resolution_long); 
            MR_2020_resolution_l = market_demand_revenues.inverse_demand.year_4.total.(scenario).marginal_revenue_resolution_long;
            MR_2020_forecast = market_demand_revenues.inverse_demand.year_4.total.(scenario).marginal_revenue_resolution(end);

            set(f,'Visible','on'); 
            subplot(1,2,1);
            hold on;
            plot(Q_2016_resolution_l/1024/1024, P_2016_resolution_l, 'r', 'LineWidth', 4); 
            plot(Q_2016_resolution_l/1024/1024, MR_2016_resolution_l, 'r--', 'LineWidth', 4); 
            plot(Q_2016_resolution_l/1024/1024, P_2016_est_current*ones(1,length(Q_2016_resolution_l)), 'y', 'LineWidth', 4);
            plot(Q_2016_resolution_l/1024/1024, MR_2016_current*ones(1,length(Q_2016_resolution_l)), 'y', 'LineWidth', 2);
            plot(Q_2016_current/1024/1024, P_2016_est_current, 'd','MarkerSize', 15, 'LineWidth', 3,'MarkerEdgeColor','k','MarkerFaceColor','none'); %2016 market equilibrium on 4G demand curve
            plot(Q_2016_current/1024/1024, MR_2016_current, 'd','MarkerSize', 12, 'LineWidth', 2,'MarkerEdgeColor','k'); 
            set(gca,'FontSize',20);
            xlabel('Quantity Q (PB/month)');
            ylabel('Price P (EURO per GB/month)');
            legend({'Demand Curve (4G)','Marginal Revenue','max Marginal Cost (MC=P)','min Marginal Cost (MC=MR)'},'Location','Northeast','FontSize',12);
            set(gca,'xscale','log');
            set(gca,'yscale','log');
            set(gca,'xLim',[inputs_demand_parameters.quantity(end-1)/1024/1024 Q_2020_resolution_l(end)/1024/1024])
            set(gca,'xTick',[Q_2016_current Q_2020_forecast]/1024/1024)
            set(gca, 'XTickLabel', num2str(get(gca,'xTick')','%0.0f'));
            set(gca,'yLim',[MR_2020_forecast/3 10]);
            set(gca,'yTick',sort([MR_2016_current P_2016_est_current MR_2020_forecast]));
            set(gca, 'YTickLabel', num2str(get(gca,'yTick')','%0.2f'));
            set(gca,'XMinorTick','off');
            set(gca,'YMinorTick','off');
            title('2016')
            hold off;
            subplot(1,2,2);
            hold on;
            plot(Q_2020_resolution_l/1024/1024, P_2020_resolution_l, 'g', 'LineWidth', 4);
            plot(Q_2020_resolution_l/1024/1024, MR_2020_resolution_l, 'g--', 'LineWidth', 4);
            plot(Q_2020_resolution_l/1024/1024, P_2020_forecast*ones(1,length(Q_2020_resolution_l)), 'k', 'LineWidth', 4);
            plot(Q_2020_resolution_l/1024/1024, MR_2020_forecast*ones(1,length(Q_2020_resolution_l)), 'k', 'LineWidth', 2);
            plot(Q_2020_forecast/1024/1024, P_2020_forecast, 'o','MarkerSize', 15, 'LineWidth', 3,'MarkerEdgeColor','r','MarkerFaceColor','none');  %2020 Medium scenario market equilibrium
            plot(Q_2020_forecast/1024/1024, MR_2020_forecast, 'o','MarkerSize', 12, 'LineWidth', 2,'MarkerEdgeColor','r'); 
            set(gca,'FontSize',20);
            xlabel('Quantity Q (PB/month)');
            ylabel('Price P (EURO per GB/month)');
            legend({'5G Demand (2020)','5G Marginal Revenue','5G max Marginal Cost (MC=P)','5G min Marginal Cost (MC=MR)'},'Location','Northeast','FontSize',12);
            set(gca,'xscale','log');
            set(gca,'yscale','log');
            set(gca,'xLim',[inputs_demand_parameters.quantity(end-1)/1024/1024 Q_2020_resolution_l(end)/1024/1024])
            set(gca,'xTick',[Q_2016_current Q_2020_forecast]/1024/1024)
            set(gca, 'XTickLabel', num2str(get(gca,'xTick')','%0.0f'));
            set(gca,'yLim',[MR_2020_forecast/3 10]);
            set(gca,'yTick',sort([MR_2020_forecast  P_2020_forecast P_2016_est_current]));
            set(gca, 'YTickLabel', num2str(get(gca,'yTick')','%0.2f'));
            set(gca,'XMinorTick','off');
            set(gca,'YMinorTick','off');  
            title('2020 (medium traffic growth scenario)')
            hold off;
        otherwise
            %do nothing
    end
end

function plotProfitFigures(hObject,eventdata)
    
    strmenu = get(hObject,'String');
    val = get(hObject,'Value');
 
    f = figure(...
            'Color', [0.8 0.8 0.8], ...
            'Visible','off',...
            'Units','normalized',...
            'Position',[0.15,0.15,0.8,0.8],...
            'Name',strmenu{val},...
            'NumberTitle','off',...
            'Resize','on',...
            'MenuBar', 'figure',...
            'Toolbar','none');  
        
    movegui(f,'center');
    
    fah = axes(...
            'Parent',f,...
            'Units', 'normalized', ...
            'Position',[0.1 0.1 0.8 0.8]);         
       
    switch strmenu{val};
             case 'Annual traffic for operator'
                Q = (network_information.all_RAN.total_throughput_Mbps*60*60*24*30/8/1024)*(1+inputs_market_industry.service.ULtoDLratio);
                MDfit_x = market_demand_revenues.traffic_fit.T;
                MDg_x = market_demand_revenues.traffic_forecast_geometric.T;
                MDe_x = market_demand_revenues.traffic_forecast_exponential.T;
                MDp_x = market_demand_revenues.traffic_forecast_power.T;
                MDfit_y = market_demand_revenues.traffic_fit.Y*inputs_demand_parameters.market_share_mno(end)* market_demand_revenues.operator_region_data_weight_factor;
                MDg_y = market_demand_revenues.traffic_forecast_geometric.Y*inputs_demand_parameters.market_share_mno(end)* market_demand_revenues.operator_region_data_weight_factor;
                MDe_y = market_demand_revenues.traffic_forecast_exponential.Y*inputs_demand_parameters.market_share_mno(end)* market_demand_revenues.operator_region_data_weight_factor;
                MDp_y = market_demand_revenues.traffic_forecast_power.Y*inputs_demand_parameters.market_share_mno(end)* market_demand_revenues.operator_region_data_weight_factor;
                inv_growth = (network_information.all_RAN.total_throughput_Mbps+network_throughput_progression.all_RAN.traffic_increase(end))/network_information.all_RAN.total_throughput_Mbps;

                set(f,'Visible','on'); hold on;
                plot(MDfit_x, MDfit_y/1024/1024, 'k', 'LineWidth', 3);
                plot(MDg_x, MDg_y/1024/1024, '--b' , 'LineWidth', 3);
                plot(MDe_x, MDe_y/1024/1024, '--r' , 'LineWidth', 3);
                plot(MDp_x, MDp_y/1024/1024, '--g' , 'LineWidth', 3);
                plot(MDg_x(end), MDg_y(end)/1024/1024, 'o' , 'LineWidth', 2,'MarkerSize', 12, 'MarkerEdgeColor', 'b');
                text(MDg_x(end)+0.1, MDg_y(end)/1024/1024, ['growth: x' num2str((MDg_y(end)/Q),'%0.2f')] , 'FontSize',12 );
                plot(MDe_x(end), MDe_y(end)/1024/1024, 'o' , 'LineWidth', 2,'MarkerSize', 12, 'MarkerEdgeColor', 'r');
                text(MDe_x(end)+0.1, MDe_y(end)/1024/1024, ['growth: x' num2str((MDe_y(end)/Q),'%0.2f')] , 'FontSize',12 );
                plot(MDp_x(end), MDp_y(end)/1024/1024, 'o' , 'LineWidth', 2,'MarkerSize', 12,'MarkerEdgeColor', 'g');
                text(MDp_x(end)+0.1, MDp_y(end)/1024/1024, ['growth: x' num2str((MDp_y(end)/Q),'%0.2f')] , 'FontSize',12 );
                plot(MDfit_x(end),MDfit_y(end)/1024/1024, 'd','MarkerSize', 12, 'LineWidth', 3,'MarkerEdgeColor','k','MarkerFaceColor','none'); 
                plot([2012 2021], [inv_growth*MDfit_y(end) inv_growth*MDfit_y(end)]/1024/1024,'k:','Linewidth',1);
                text(2013+0.1, 1.1*inv_growth*MDfit_y(end)/1024/1024, ['Investment scenario can serve growth x' num2str(inv_growth,'%0.2f') ] , 'FontSize',8 );
                %set(gca,'XMinorTick','on')
                set(gca,'FontSize',20);
                set(gca,'Xtick',2012:2020)
                set(gca, 'XTickLabel', num2str(get(gca,'XTick')','%0.0f'));
                xlim([2012 2021]);
                xlabel('Year');
                ylabel('Mobile Data Traffic (PB/month)');
                legend('Mobile Data Traffic (past)','High Forecast scenario','Medium Forecast scenario','Low Forecast scenario','Orientation','vertical', 'location','northwest');
                title('Annual mobile data traffic forecast');
                hold off;
            case 'Profits for operator'
                isSR = getappdata(0, 'traffic_growth_snapshot_index');
                scenario = 'medium';
                if isSR == 1;
                    P_2016_current = inputs_demand_parameters.determinants_of_demand.price(end);  
                    P_2016_est_current = exp(market_demand_revenues.inverse_demand.year_0.MNO_regional.estimation.price_log_resolution(end)); 
                    Q_2016_current = exp(market_demand_revenues.inverse_demand.year_0.MNO_regional.estimation.quantity_log_resolution(end)); 
                    Q_2016_resolution_l = exp(market_demand_revenues.inverse_demand.year_0.MNO_regional.estimation.quantity_log_resolution_long);
                    P_2016_mno_region_l = exp(market_demand_revenues.inverse_demand.year_0.MNO_regional.estimation.price_log_resolution_long); 
                    MR_2016_mno_region_l = market_demand_revenues.inverse_demand.year_0.MNO_regional.estimation.marginal_revenue_resolution_long;
                    MR_2016_current = market_demand_revenues.inverse_demand.year_0.MNO_regional.estimation.marginal_revenue_resolution(end);

                    set(f,'Visible','on'); 
                    hold on;
                    plot(Q_2016_resolution_l/1024, P_2016_mno_region_l, 'r', 'LineWidth', 4); 
                    plot(Q_2016_resolution_l(2:end)/1024, MR_2016_mno_region_l(2:end), 'r--', 'LineWidth', 4); 
                    plot(SR_MobileDataTraffic_TB_mon, Marginal_Cost/1024, 'b', 'LineWidth', 4); 
                    plot(SR_MobileDataTraffic_TB_mon, Average_Total_Cost/1024, 'k', 'LineWidth', 4); 
                    line([1 Q_2016_current]/1024, [Average_Total_Cost(current_point)/1024 Average_Total_Cost(current_point)/1024], 'Color','k','LineStyle','--')
                    line([1 Q_2016_current]/1024, [P_2016_est_current P_2016_est_current], 'Color','k','LineStyle','--');
                    line([Q_2016_current Q_2016_current]/1024, [0.0015 P_2016_est_current],'Color','k','LineStyle','--');
                    set(gca,'FontSize',20);
                    xlabel('Quantity Q (TB/month)');
                    ylabel('EURO for GB/month in DL');
                    legend({'4G Individual Demand','4G Marginal Revenue','Marginal Cost','Average Total Cost'},'Location','Northeast','FontSize',12);
                    set(gca,'xLim',[0 Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon*1.1]);
                    set(gca,'xTick',sort([Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon Q_2016_current/1024]))
                    set(gca, 'XTickLabel', num2str(get(gca,'xTick')','%0.f'));
                    set(gca,'yLim',[0.0015 1]);
                    set(gca,'yTick',sort([MR_2016_current Marginal_Cost(current_point)/1024 P_2016_est_current Average_Total_Cost(current_point)/1024]));
                    set(gca, 'YTickLabel', num2str(get(gca,'yTick')','%0.3f'));
                    set(gca,'XMinorTick','off');
                    set(gca,'YMinorTick','off');
                    title('Profits for operator (2016)')
                    dim = [.5 .35 .3 .3];
                    ebitda_plot = 12*(Q_2016_current/(1+inputs_market_industry.service.ULtoDLratio))*(P_2016_current-Average_Total_Cost_current/1024);
                    revenue_plot = 12*Q_2016_current/(1+inputs_market_industry.service.ULtoDLratio)*P_2016_current;
                    str = {['EBITDA:' num2str(ebitda_plot,'%0.0f')];...
                            ['EBITDA margin:' num2str(ebitda_plot/revenue_plot,'%0.2f')]};
                    %ebitda_est_plot = 12*(Q_2016_current/(1+inputs_market_industry.service.ULtoDLratio))*(P_2016_est_current-Average_Total_Cost(current_point)/1024);
                    %revenue_est_plot = 12*Q_2016_current/(1+inputs_market_industry.service.ULtoDLratio)*P_2016_est_current;
    %                 str = {['EBITDA:' num2str(ebitda_plot,'%0.0f')];...
    %                         ['EBITDA margin:' num2str(ebitda_plot/revenue_plot,'%0.2f')];...
    %                         ['estimated EBITDA:' num2str(ebitda_est_plot,'%0.0f')];...
    %                         ['estimated EBITDA margin:' num2str(ebitda_est_plot/revenue_est_plot,'%0.2f')]};
                    annotation('textbox',dim,'String',str,'FitBoxToText','on');
                    hold off;
                else   
                        [LR_MobileDataTraffic_TB_mon, LR_MobileDataTraffic_DL_TB_mon, LR_current_point, LR_OPEX_FIX_total, LR_OPEX_VAR_total, LR_OPEX_VAR_total_current,...
                      LR_OPEX_total, LR_OPEX_total_current, LR_network_throughput_regional_TB_mon, LR_network_throughput_regional_DL_TB_mon,LR_Max_Traffic_to_be_satisfied_regional_TB_mon, ...
                      LR_Max_Traffic_to_be_satisfied_regional_DL_TB_mon, LR_Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon, LR_Max_Traffic_to_be_satisfied_techlimit_regional_DL_TB_mon,...
                      LR_actual_max_network_capacity_regional_DL_TB_mon, LR_Average_Total_Cost, LR_Average_Total_Cost_current, LR_Average_Fixed_Cost, LR_Average_Variable_Cost, LR_Marginal_Cost,...
                      LR_inputs_market_industry,LR_inputs_finance, LR_inputs_technology, market_demand_revenues,average_investment_cost...
                      LR_Efix_net, LR_Evar_net, LR_Average_Total_Cost_of_GB, LR_Average_user_data, LR_RAN_operating_cost_structure,LR_RAN_operating_cost,LR_RANtoCORE_operating_cost,LR_CORE_operating_cost,LR_Total_operating_cost_structure,...
                      traffic_growth_snapshot_time, LR_network_information_growth_snapshot, LR_site_infrastructure, LR_network_information, LR_network_cost, LR_network_energy] =...
                    get_process_data_from_external_world();
    
                     
                    P_2016_current = inputs_demand_parameters.determinants_of_demand.price(end);  
                    P_2016_est_current = exp(market_demand_revenues.inverse_demand.year_0.MNO_regional.estimation.price_log_resolution(end)); 
                    Q_2016_current = exp(market_demand_revenues.inverse_demand.year_0.MNO_regional.estimation.quantity_log_resolution(end)); 
                    Q_2016_resolution_l = exp(market_demand_revenues.inverse_demand.year_0.MNO_regional.estimation.quantity_log_resolution_long);
                    P_2016_mno_region_l = exp(market_demand_revenues.inverse_demand.year_0.MNO_regional.estimation.price_log_resolution_long); 
                    MR_2016_mno_region_l = market_demand_revenues.inverse_demand.year_0.MNO_regional.estimation.marginal_revenue_resolution_long;
                    MR_2016_current = market_demand_revenues.inverse_demand.year_0.MNO_regional.estimation.marginal_revenue_resolution(end);
                    
                    switch traffic_growth_snapshot_time
                        case '2017'
                            year = 'year_1';
                        case '2018'
                            year = 'year_2';
                        case '2019'
                            year = 'year_3';
                        case '2020'
                            year = 'year_4';
                        case '2021'
                            year = 'year_5';
                    end

                    P_20xx_forecast = exp(market_demand_revenues.inverse_demand.(year).MNO_regional.(scenario).actual.price_log_resolution(end)); 
                    Q_20xx_forecast = exp(market_demand_revenues.inverse_demand.(year).MNO_regional.(scenario).actual.quantity_log_resolution(end)); 
                    Q_20xx_resolution_l = exp(market_demand_revenues.inverse_demand.(year).MNO_regional.(scenario).actual.quantity_log_resolution_long);
                    P_20xx_mno_region_l = exp(market_demand_revenues.inverse_demand.(year).MNO_regional.(scenario).actual.price_log_resolution_long); 
                    MR_20xx_mno_region_l = market_demand_revenues.inverse_demand.(year).MNO_regional.(scenario).actual.marginal_revenue_resolution_long;
                    MR_20xx_forecast = market_demand_revenues.inverse_demand.(year).MNO_regional.(scenario).actual.marginal_revenue_resolution(end);
                  

                    set(f,'Visible','on'); 
                    subplot(1,2,1);
                    hold on;
                    plot(Q_2016_resolution_l/1024, P_2016_mno_region_l, 'r', 'LineWidth', 4); 
                    plot(Q_2016_resolution_l(2:end)/1024, MR_2016_mno_region_l(2:end), 'r--', 'LineWidth', 4); 
                    plot(SR_MobileDataTraffic_TB_mon, Marginal_Cost/1024, 'b', 'LineWidth', 4); 
                    plot(SR_MobileDataTraffic_TB_mon, Average_Total_Cost/1024, 'k', 'LineWidth', 4); 
                    line([1 Q_2016_current]/1024, [Average_Total_Cost(current_point)/1024 Average_Total_Cost(current_point)/1024], 'Color','k','LineStyle','--')
                    line([1 Q_2016_current]/1024, [P_2016_est_current P_2016_est_current], 'Color','k','LineStyle','--');
                    line([Q_2016_current Q_2016_current]/1024, [0.0015 P_2016_est_current],'Color','k','LineStyle','--');
                    set(gca,'FontSize',20);
                    xlabel('Quantity Q (TB/month)');
                    ylabel('EURO for GB/month in DL');
                    legend({'4G Individual Demand','4G Marginal Revenue','Marginal Cost','Average Total Cost'},'Location','Northeast','FontSize',12);
                    set(gca,'xLim',[0 Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon*1.1]);
                    set(gca,'xTick',sort([Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon Q_2016_current/1024]))
                    set(gca, 'XTickLabel', num2str(get(gca,'xTick')','%0.f'),'FontSize',12);
                    set(gca,'yLim',[0.0005 1]);
                    set(gca,'yTick',sort([MR_2016_current Marginal_Cost(current_point)/1024 P_2016_est_current Average_Total_Cost(current_point)/1024]));
                    set(gca, 'YTickLabel', num2str(get(gca,'yTick')','%0.3f'),'FontSize',12);
                    set(gca,'XMinorTick','off');
                    set(gca,'YMinorTick','off');
                    title('Profits for operator (2016)','FontSize',20)
                    dim = [.3 .35 .3 .3];
                    ebitda_plot = 12*(Q_2016_current/(1+inputs_market_industry.service.ULtoDLratio))*(P_2016_current-Average_Total_Cost_current/1024);
                    revenue_plot = 12*Q_2016_current/(1+inputs_market_industry.service.ULtoDLratio)*P_2016_current;
                    str = {['EBITDA:' num2str(ebitda_plot,'%0.0f')];...
                            ['EBITDA margin:' num2str(ebitda_plot/revenue_plot,'%0.2f')]};
                    annotation('textbox',dim,'String',str,'FitBoxToText','on');
                    hold off;

                    subplot(1,2,2);
                    hold on;
                    plot(Q_20xx_resolution_l/1024, P_20xx_mno_region_l, 'r', 'LineWidth', 4); 
                    plot(Q_20xx_resolution_l(2:end)/1024, MR_20xx_mno_region_l(2:end), 'r--', 'LineWidth', 4); 
                    plot(LR_MobileDataTraffic_TB_mon, LR_Marginal_Cost/1024, 'b', 'LineWidth', 4); 
                    plot(LR_MobileDataTraffic_TB_mon, LR_Average_Total_Cost/1024, 'k', 'LineWidth', 4); 
                    plot(LR_MobileDataTraffic_TB_mon, (average_investment_cost+LR_Average_Total_Cost)/1024, 'k:', 'LineWidth', 2); 
                    line([1 Q_20xx_forecast]/1024, [LR_Average_Total_Cost(LR_current_point)/1024 LR_Average_Total_Cost(LR_current_point)/1024], 'Color','k','LineStyle','--')
                    line([1 Q_20xx_forecast]/1024, [P_20xx_forecast P_20xx_forecast], 'Color','k','LineStyle','--');
                    line([Q_20xx_forecast Q_20xx_forecast]/1024, [0.0015 P_20xx_forecast],'Color','k','LineStyle','--');
                    set(gca,'FontSize',20);
                    xlabel('Quantity Q (TB/month)');
                    ylabel('EURO for GB/month in DL');
                    legend({'Individual Demand','Marginal Revenue','Marginal Cost','Average Total Cost', 'ATC+investments'},'Location','Northeast','FontSize',12);
                    set(gca,'xLim',[0 LR_Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon*1.1]);
                    set(gca,'xTick',sort([LR_Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon Q_20xx_forecast/1024]))
                    set(gca, 'XTickLabel', num2str(get(gca,'xTick')','%0.f'),'FontSize',12);
                    set(gca,'yLim',[0.0005 1]);
                    set(gca,'yTick',sort([(average_investment_cost(LR_current_point)+LR_Average_Total_Cost(LR_current_point))/1024 MR_20xx_forecast LR_Marginal_Cost(LR_current_point)/1024 P_20xx_forecast LR_Average_Total_Cost(LR_current_point)/1024]));
                    set(gca, 'YTickLabel', num2str(get(gca,'yTick')','%0.3f'),'FontSize',12);
                    set(gca,'XMinorTick','off');
                    set(gca,'YMinorTick','off');
                    title(['Profits for operator (' traffic_growth_snapshot_time ')'],'FontSize',20)
                    dim = [.75 .35 .3 .3];
                    ebitda_plot = 12*(Q_20xx_forecast/(1+LR_inputs_market_industry.service.ULtoDLratio))*(P_20xx_forecast-LR_Average_Total_Cost_current/1024);
                    revenue_plot = 12*Q_20xx_forecast/(1+LR_inputs_market_industry.service.ULtoDLratio)*P_20xx_forecast;
                    str = {['EBITDA:' num2str(ebitda_plot,'%0.0f')];...
                            ['EBITDA margin:' num2str(ebitda_plot/revenue_plot,'%0.2f')]};
                    annotation('textbox',dim,'String',str,'FitBoxToText','on');
                    hold off;
                end
        otherwise
            %do nothing
    end
end
    
function plotNetworkSRcostInformation(hObject,eventdata)
    fn = figure(...
            'Color', [0.8 0.8 0.8], ...
            'Visible','off',...
            'Units','normalized',...
            'Position',[0.15,0.15,0.8,0.8],...
            'Name','Network cost structure',...
            'NumberTitle','off',...
            'Resize','on',...
            'MenuBar', 'figure',...
            'Toolbar','none');  
        
    movegui(fn,'center');
    set(fn,'Visible','on');
    
    fnah = axes(...
            'Parent',fn,...
            'Units', 'normalized', ...
            'Position',[0.1 0.1 0.8 0.8]);     
      
    
    labels1 = {'Site rental','Operation and Maintenance','Energy','Transmission','Personnel','Other'};
    fnah1 = subplot(1,2,1);
    pie(fnah1,SR_RAN_operating_cost_structure(SR_RAN_operating_cost_structure>0));  
    legend(fnah1,labels1(SR_RAN_operating_cost_structure>0),'Location','southoutside','Orientation','vertical')
    title(fnah1,[num2str(inputs_finance.current_year) ': RAN operating cost structure' ],'fontweight','bold','fontsize',16);
                            
    labels2 = {'RAN', 'RAN to Core', 'Core','Interconnection and other fees','Selling, General and Administrative'};
    fnah2 = subplot(1,2,2);
    pie(fnah2,SR_Total_operating_cost_structure(SR_Total_operating_cost_structure>0));
    legend(fnah2,labels2(SR_Total_operating_cost_structure>0),'Location','southoutside','Orientation','vertical');
    title(fnah2,[num2str(inputs_finance.current_year) ': Total operating cost structure' ],'fontweight','bold','fontsize',16);
                                      
end

function demand_slider(hObject,callbackdata)
    sval = ceil(get(hObject,'Value'));      
    growth = network_throughput_progression.all_RAN.growth(sval);      
    data = struct('index',sval,'growth',growth);
    set(hObject,'UserData',data);
    
    set(sth,'String',['x' num2str(growth,'%.3f')])
    set(findobj('Tag','panel_LR_in_slider'),'visible','off');
    set(findobj('Tag','push_button_in_slider'),'visible','on'); 
    setappdata(0, 'traffic_growth_snapshot_index', 1);
end

function pushbutton_demand_growth(hObject,callbackdata)
    data = get(findobj('Tag','slider_demand_growth'),'UserData');  
    setappdata(0, 'traffic_growth_snapshot_index', data.index);
    
    if data.index == 1;
        msgbox('Move the mobile data trafifc growth slider')
    else  
        set(findobj('Tag','push_button_in_slider'),'visible','off');  
        set(findobj('Tag','push_button_in_table'),'Enable','on');
    end
    
end

function plotNetworkLRcostFigures(hObject,eventdata)
    
    [LR_MobileDataTraffic_TB_mon, LR_MobileDataTraffic_DL_TB_mon, LR_current_point, LR_OPEX_FIX_total, LR_OPEX_VAR_total, LR_OPEX_VAR_total_current,...
          LR_OPEX_total, LR_OPEX_total_current, LR_network_throughput_regional_TB_mon, LR_network_throughput_regional_DL_TB_mon,LR_Max_Traffic_to_be_satisfied_regional_TB_mon, ...
          LR_Max_Traffic_to_be_satisfied_regional_DL_TB_mon, LR_Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon, LR_Max_Traffic_to_be_satisfied_techlimit_regional_DL_TB_mon,...
          LR_actual_max_network_capacity_regional_DL_TB_mon, LR_Average_Total_Cost, LR_Average_Total_Cost_current, LR_Average_Fixed_Cost, LR_Average_Variable_Cost, LR_Marginal_Cost,...
          LR_inputs_market_industry,LR_inputs_finance, LR_inputs_technology,market_demand_revenues,average_investment_cost...
          LR_Efix_net, LR_Evar_net, LR_Average_Total_Cost_of_GB, LR_Average_user_data, LR_RAN_operating_cost_structure,LR_RAN_operating_cost,LR_RANtoCORE_operating_cost,LR_CORE_operating_cost,LR_Total_operating_cost_structure,...
          traffic_growth_snapshot_time, LR_network_information_growth_snapshot, LR_site_infrastructure, LR_network_information, LR_network_cost, LR_network_energy] =...
        get_process_data_from_external_world();
    
    strmenu = get(hObject,'String');
    val = get(hObject,'Value');
 
    f = figure(...
            'Color', [0.8 0.8 0.8], ...
            'Visible','off',...
            'Units','normalized',...
            'Position',[0.15,0.15,0.8,0.8],...
            'Name',['LR_' strmenu{val}],...
            'NumberTitle','off',...
            'Resize','on',...
            'MenuBar', 'figure',...
            'Toolbar','none');  
        
    movegui(f,'center');
    
    fah = axes(...
            'Parent',f,...
            'Units', 'normalized', ...
            'Position',[0.1 0.1 0.8 0.8]);         
       
    switch strmenu{val};
        case 'Investments'
            set(f,'Visible','on'); hold on;  
            fnah = axes(...
                'Parent',f,...
                'Units', 'normalized', ...
                'Position',[0.1 0.1 0.8 0.8]);     
                                  
            labels1 = {'RAN: Site development','RAN: Site equipment','RAN: Basestations','RAN: Controllers','RAN: Owned transmission lines','RAN: Other tangible fixed asset',...
                'RANtoCORE: Owned transmission lines','RANtoCORE: Other tangible fixed asset',...
                'CORE: PSnetwork elements','CORE: Common network elements','CORE: Owned transmission lines','CORE: other tangible fixed asset',...
                'non_network: Tangible fixed assets','non_network: Intangible fixed assets '};
            fnah1 = subplot(1,2,1);
        
            LR_investment_cost_structure = [sum(LR_network_cost.all_RAN.investment_cost.RAN_site_development)...
                                            sum(LR_network_cost.all_RAN.investment_cost.RAN_site_equipment)...
                                            sum(LR_network_cost.all_RAN.investment_cost.RAN_basestations)...
                                            sum(LR_network_cost.all_RAN.investment_cost.RAN_controllers)...
                                            sum(LR_network_cost.all_RAN.investment_cost.RAN_owned_transmission_lines)...
                                            sum(LR_network_cost.all_RAN.investment_cost.RAN_other_tangible_fixed_asset)...
                                            sum(LR_network_cost.all_RAN.investment_cost.RANtoCORE_owned_transmission_lines)...
                                            sum(LR_network_cost.all_RAN.investment_cost.RANtoCORE_other_tangible_fixed_asset)...
                                            sum(LR_network_cost.all_RAN.investment_cost.CORE_PSnetwork_elements)...
                                            sum(LR_network_cost.all_RAN.investment_cost.CORE_common_network_elements)...
                                            sum(LR_network_cost.all_RAN.investment_cost.CORE_owned_transmission_lines)...
                                            sum(LR_network_cost.all_RAN.investment_cost.CORE_other_tangible_fixed_asset)...
                                            sum(LR_network_cost.all_RAN.investment_cost.non_network_tangible_fixed_assets)...
                                            sum(LR_network_cost.all_RAN.investment_cost.non_network_intangible_fixed_assets)];

            LR_cum_investment_cost = sum(LR_network_cost.all_RAN.investment_cost.RAN_site_development)+...
                                sum(LR_network_cost.all_RAN.investment_cost.RAN_site_equipment)+...
                                sum(LR_network_cost.all_RAN.investment_cost.RAN_basestations)+...
                                sum(LR_network_cost.all_RAN.investment_cost.RAN_controllers)+...
                                sum(LR_network_cost.all_RAN.investment_cost.RAN_owned_transmission_lines)+...
                                sum(LR_network_cost.all_RAN.investment_cost.RAN_other_tangible_fixed_asset)+...
                                sum(LR_network_cost.all_RAN.investment_cost.RANtoCORE_owned_transmission_lines)+...
                                sum(LR_network_cost.all_RAN.investment_cost.RANtoCORE_other_tangible_fixed_asset)+...
                                sum(LR_network_cost.all_RAN.investment_cost.CORE_PSnetwork_elements)+...
                                sum(LR_network_cost.all_RAN.investment_cost.CORE_common_network_elements)+...
                                sum(LR_network_cost.all_RAN.investment_cost.CORE_owned_transmission_lines)+...
                                sum(LR_network_cost.all_RAN.investment_cost.CORE_other_tangible_fixed_asset)+...
                                sum(LR_network_cost.all_RAN.investment_cost.non_network_tangible_fixed_assets)+...
                                sum(LR_network_cost.all_RAN.investment_cost.non_network_intangible_fixed_assets);                                        
                                        
            pie(fnah1,LR_investment_cost_structure(LR_investment_cost_structure>0));  
            legend(fnah1,labels1(LR_investment_cost_structure>0),'Location','southoutside','Orientation','vertical')
            title(fnah1,['Cumulated investments (' num2str(inputs_finance.current_year+1) '-' num2str(LR_inputs_finance.current_year) ': ' num2str(LR_cum_investment_cost, '%.2f') ')'],'fontweight','bold','fontsize',16);

            fnah2 = subplot(1,2,2);         
            investment_sites = size(LR_network_information_growth_snapshot.critical_sites.investment_sites,2);
            no_investment_sites_affected_by_investments = size(LR_network_information_growth_snapshot.critical_sites.no_investment_sites_affected_by_investments,2);
            no_investment_sites = size(LR_network_information_growth_snapshot.critical_sites.no_investment_sites,2);
            sites_to_remove_equip = size(LR_network_information_growth_snapshot.critical_sites.sites_to_remove_equip,2);
            territory_coverage = LR_inputs_technology.LR.EUTRAN_CA_territory_coverage_new(7);                       
            y = [investment_sites; no_investment_sites_affected_by_investments; no_investment_sites; sites_to_remove_equip];
            bar(y);
            ylim([0 max(y)+5]);
            set(gca,'FontSize',11);
            title({'Network changes on sites which require investment (number of sites)', ['Scenario area coverage: ' num2str(100*territory_coverage, '%0.1f%%')]},'fontweight','bold','fontsize',12);
            set(gca,'ytick',[]);
            box on;
            text(1,y(1),num2str(investment_sites),'HorizontalAlignment','center','VerticalAlignment','bottom');
            text(2,y(2),num2str(no_investment_sites_affected_by_investments),'HorizontalAlignment','center','VerticalAlignment','bottom');
            text(3,y(3),num2str(no_investment_sites),'HorizontalAlignment','center','VerticalAlignment','bottom');
            text(4,y(4),num2str(sites_to_remove_equip),'HorizontalAlignment','center','VerticalAlignment','bottom');
            set(gca,'XTickLabel',{'investment', 'no direct investment', 'no investment','unistalled equipment'},'FontSize',8);
            hold off;
        case 'Total operating cost' 
            set(f,'Visible','on'); hold on;           
            plot(fah,LR_MobileDataTraffic_TB_mon,LR_OPEX_total/1000,'k','linewidth',3); 
            plot(fah,[LR_network_throughput_regional_TB_mon LR_network_throughput_regional_TB_mon], [0 (LR_OPEX_total(end)/1000+(LR_OPEX_total(end)/1000-LR_OPEX_total(1)/1000)*0.2)],'k:');        
            set(fah,'FontSize',20);
            axis([0 LR_Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon*1.1 (LR_OPEX_total(1)/1000-(LR_OPEX_total(end)/1000-LR_OPEX_total(1)/1000)*0.2) (LR_OPEX_total(end)/1000+(LR_OPEX_total(end)/1000-LR_OPEX_total(1)/1000)*0.2)]);
            f1L = get(fah,'yLim');
            set(fah,'ytick',linspace(f1L(1),f1L(2),6));
            set(fah,'yTickLabel',num2str(get(fah,'ytick').','%.2f'));
            xlabel('Data Traffic (TB/month)');
            ylabel('thousand EUR/month');
            legend('Total (operating) cost','Current data traffic volume','Orientation','vertical', 'location','northwest');
            title(['Region ' num2str(LR_inputs_market_industry.demographics.land_Area_km2) ' km^{2}']);
            text(0.55,0.885,{[num2str(LR_actual_max_network_capacity_regional_DL_TB_mon,'%.0f'),' TB/mon is the actual DL network capacity']; ...
                [num2str(LR_Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon,'%.0f'),' TB/mon is the max throughput with even traffic distribution'];...
                [num2str(LR_Max_Traffic_to_be_satisfied_regional_TB_mon,'%.0f'),' TB/mon is the max throughput with even traffic distribution and capacity load ceiling'];...
                [num2str(LR_network_throughput_regional_TB_mon,'%.0f'),' TB/mon is the current throughput']},'units','normalized');
            hold off;
        case 'Unit cost curves' 
            set(f,'Visible','on'); hold on;
            plot(fah,LR_MobileDataTraffic_TB_mon,LR_Average_Total_Cost/1000,'m','linewidth',3);
            plot(fah,LR_MobileDataTraffic_TB_mon,LR_Average_Fixed_Cost/1000,'b--','linewidth',2);
            plot(fah,LR_MobileDataTraffic_TB_mon,LR_Average_Variable_Cost/1000,'g','linewidth',3);
            plot(fah,LR_MobileDataTraffic_TB_mon,LR_Marginal_Cost/1000,'r--','linewidth',2);
            plot(fah,[LR_network_throughput_regional_TB_mon LR_network_throughput_regional_TB_mon], [0 5],'k:');
            set(fah,'FontSize',20);
            axis([2 LR_Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon*1.1 0 5]);
            f2L = get(fah,'yLim');
            set(fah,'ytick',linspace(f2L(1),f2L(2),6));
            set(fah,'yTickLabel',num2str(get(fah,'ytick').','%.2f'));
            xlabel('Data Traffic (TB/month)');
            ylabel('thousand EUR/TB');
            legend('Average Total Cost','Average Fixed Cost','Average Variable Cost','Marginal cost');
            title('Unit cost curves');
            text(LR_MobileDataTraffic_TB_mon(end),LR_Average_Total_Cost(end)/1000,num2str(LR_Average_Total_Cost(end)/1000),'Color','m');
            text(LR_MobileDataTraffic_TB_mon(end),-0.05,num2str(LR_Marginal_Cost(end)/1000),'Color','r');
            text(0.3,0.585,{'At the current traffic level:';...
                [num2str(LR_Average_Total_Cost(LR_current_point)/1024,'%.4f'),' EUR per GB/mon is the Average Total Cost']; ...
                [num2str(LR_Average_Fixed_Cost(LR_current_point)/1024,'%.4f'),' EUR per GB/mon is the Average Fixed Cost'];...
                [num2str(LR_Average_Variable_Cost(LR_current_point)/1024,'%.4f'),' EUR per GB/mon is the Average Variable Cost'];...
                [num2str(LR_Marginal_Cost(LR_current_point)/1024,'%.4f'),' EUR for one additional GB/mon is the Marginal Cost']},'units','normalized');
            hold off;
        case 'Energy Consumption' 
            set(f,'Visible','on'); hold on;
            plot(fah,LR_MobileDataTraffic_TB_mon, LR_Efix_net*ones(1,length(LR_MobileDataTraffic_TB_mon)),'r','linewidth',3);
            plot(fah,LR_MobileDataTraffic_TB_mon,LR_Evar_net,'b','linewidth',3);
            plot(fah,LR_MobileDataTraffic_TB_mon, (LR_Efix_net*ones(1,length(LR_MobileDataTraffic_TB_mon))+LR_Evar_net),'k','linewidth',3);
            plot(fah,[LR_network_throughput_regional_TB_mon LR_network_throughput_regional_TB_mon], [0 ((LR_Efix_net+LR_Evar_net(end))*1.1)],'k:');
            set(fah,'FontSize',20);
            axis([0 LR_Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon*1.1 0 ((LR_Efix_net+LR_Evar_net(end))*1.1)]);
            L = get(fah,'yLim');
            set(fah,'ytick',linspace(L(1),L(2),6));
            set(fah,'yTickLabel',num2str(get(fah,'ytick').','%.2f'));
            xlabel('Data Traffic (TB/month)'); 
            ylabel('Energy (MWh/month)');
            legend('Fixed','Variable','Total','Orientation','horizontal','location','northwest');
            title('Energy Consumption');
            text(0.3,0.585,{'At the current traffic level:';...
                [num2str(LR_Efix_net,'%.4f'),' MWh/month is the Fixed energy consumption']; ...
                [num2str(LR_Evar_net(LR_current_point),'%.4f'),' MWh/month is the Variable energy consumption'];...
                [num2str(LR_Efix_net+LR_Evar_net(LR_current_point),'%.4f'),' MWh/month is the Total energy consumption']},'units','normalized');
            hold off;
        case 'Cost per GB and GB per data user (in DL)'
            set(f,'Visible','on');hold on;
            plot(fah,[LR_network_throughput_regional_TB_mon LR_network_throughput_regional_TB_mon], [0 10],'k:');
            [hAx,hLine1,hLine2] = plotyy(fah,LR_MobileDataTraffic_TB_mon,LR_Average_Total_Cost_of_GB,LR_MobileDataTraffic_TB_mon,LR_Average_user_data);
            set(hLine1,'LineWidth',2,'Color','b');
            set(hLine2,'LineWidth',3,'Color','r');
            set(hAx,{'ycolor'},{'b';'r'}) 
            set(hAx(1),'FontSize',20);
            set(hAx(2),'FontSize',20);
            set(hAx(1),'box','off');
            set(hAx(1),'ylim',[0, 10]);
            L = get(hAx(1),'yLim');
            R = get(hAx(2),'yLim');
            set(hAx(1),'ytick',linspace(L(1),L(2),6));
            set(hAx(1),'yTickLabel',num2str(get(hAx(1),'ytick').','%.2f'));
            set(hAx(2),'ytick',linspace(R(1),R(2),6));
            set(hAx(2),'yTickLabel',num2str(get(hAx(2),'ytick').','%.2f'));
            set(hAx(1),'xlim',[0, LR_Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon*1.1 ]);
            set(hAx(2),'xlim',[0, LR_Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon*1.1 ]);
            xlabel('Data Traffic (TB/month)');
            ylabel(hAx(1),'Cost per GB (EUR/GB)');
            ylabel(hAx(2),'Data usage per user (GB/month)');
            title('Cost per GB and GB per data user');
            text(LR_MobileDataTraffic_TB_mon(end),LR_Average_Total_Cost_of_GB(end),num2str(LR_Average_Total_Cost_of_GB(end)),'Color','b','parent',hAx(1));
            text(LR_MobileDataTraffic_TB_mon(end),LR_Average_user_data(end),num2str(LR_Average_user_data(end)),'Color','r','parent',hAx(2));  
            text(0.3,0.585,{'At the current traffic level:';...
                [num2str(LR_Average_Total_Cost_of_GB(LR_current_point),'%.4f'),' EUR/GB'];...
                [num2str(LR_Average_user_data(LR_current_point),'%.4f'),' GB/month is the average user data rate']},'units','normalized');
            hold off;
        otherwise
            %do nothing
    end
end

function togglebutton_SiteInformation_LR(hObject,callbackdata)
    button_state = get(hObject,'Value');   
    dcm_obj = datacursormode(hMainFigure);
    if button_state == get(hObject,'Max')
        set(hObject,'TooltipString','select now a site for information');
        datacursormode on;
        set(dcm_obj,'UpdateFcn', @datacursor_LR );   
        set(dcm_obj,'DisplayStyle', 'window' ); 
    elseif button_state == get(hObject,'Min')
        set(hObject,'TooltipString','Click here and choose a site to access information');
        datacursormode off;
        cla(ahsoutheast,'reset');
        set(ahsoutheast,'Visible','off');
    end
          
end  

function plotNetworkLRcostInformation(hObject,eventdata)
        [LR_MobileDataTraffic_TB_mon, LR_MobileDataTraffic_DL_TB_mon, LR_current_point, LR_OPEX_FIX_total, LR_OPEX_VAR_total, LR_OPEX_VAR_total_current,...
          LR_OPEX_total, LR_OPEX_total_current, LR_network_throughput_regional_TB_mon, LR_network_throughput_regional_DL_TB_mon,LR_Max_Traffic_to_be_satisfied_regional_TB_mon, ...
          LR_Max_Traffic_to_be_satisfied_regional_DL_TB_mon, LR_Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon, LR_Max_Traffic_to_be_satisfied_techlimit_regional_DL_TB_mon,...
          LR_actual_max_network_capacity_regional_DL_TB_mon, LR_Average_Total_Cost, LR_Average_Total_Cost_current, LR_Average_Fixed_Cost, LR_Average_Variable_Cost, LR_Marginal_Cost,...
          LR_inputs_market_industry,LR_inputs_finance, LR_inputs_technology,market_demand_revenues,average_investment_cost...
          LR_Efix_net, LR_Evar_net, LR_Average_Total_Cost_of_GB, LR_Average_user_data, LR_RAN_operating_cost_structure,LR_RAN_operating_cost,LR_RANtoCORE_operating_cost,LR_CORE_operating_cost,LR_Total_operating_cost_structure,...
          traffic_growth_snapshot_time, LR_network_information_growth_snapshot, LR_site_infrastructure, LR_network_information, LR_network_cost, LR_network_energy] =...
        get_process_data_from_external_world();
    
    fn = figure(...
            'Color', [0.8 0.8 0.8], ...
            'Visible','off',...
            'Units','normalized',...
            'Position',[0.15,0.15,0.8,0.8],...
            'Name','LR Network cost structure',...
            'NumberTitle','off',...
            'Resize','on',...
            'MenuBar', 'figure',...
            'Toolbar','none');  
        
    movegui(fn,'center');
    set(fn,'Visible','on');
    
    fnah = axes(...
            'Parent',fn,...
            'Units', 'normalized', ...
            'Position',[0.1 0.1 0.8 0.8]);     
      
    
    labels1 = {'Site rental','Operation and Maintenance','Energy','Transmission','Personnel','Other'};
    fnah1 = subplot(1,2,1);
    pie(fnah1,LR_RAN_operating_cost_structure(LR_RAN_operating_cost_structure>0));  
    legend(fnah1,labels1(LR_RAN_operating_cost_structure>0),'Location','southoutside','Orientation','vertical')
    title(fnah1,[num2str(LR_inputs_finance.current_year) ': RAN operating cost structure' ],'fontweight','bold','fontsize',16);
                            
    labels2 = {'RAN', 'RAN to Core', 'Core','Interconnection and other fees','Selling, General and Administrative'};
    fnah2 = subplot(1,2,2);
    pie(fnah2,LR_Total_operating_cost_structure(LR_Total_operating_cost_structure>0));
    legend(fnah2,labels2(LR_Total_operating_cost_structure>0),'Location','southoutside','Orientation','vertical');
    title(fnah2,[num2str(LR_inputs_finance.current_year) ': Total operating cost structure' ],'fontweight','bold','fontsize',16);
                                      
end

function update_LRtable(hObject,eventdata) 
    
    [LR_MobileDataTraffic_TB_mon, LR_MobileDataTraffic_DL_TB_mon, LR_current_point, LR_OPEX_FIX_total, LR_OPEX_VAR_total, LR_OPEX_VAR_total_current,...
          LR_OPEX_total, LR_OPEX_total_current, LR_network_throughput_regional_TB_mon, LR_network_throughput_regional_DL_TB_mon,LR_Max_Traffic_to_be_satisfied_regional_TB_mon, ...
          LR_Max_Traffic_to_be_satisfied_regional_DL_TB_mon, LR_Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon, LR_Max_Traffic_to_be_satisfied_techlimit_regional_DL_TB_mon,...
          LR_actual_max_network_capacity_regional_DL_TB_mon, LR_Average_Total_Cost, LR_Average_Total_Cost_current, LR_Average_Fixed_Cost, LR_Average_Variable_Cost, LR_Marginal_Cost,...
          LR_inputs_market_industry,LR_inputs_finance, LR_inputs_technology,market_demand_revenues,average_investment_cost...
          LR_Efix_net, LR_Evar_net, LR_Average_Total_Cost_of_GB, LR_Average_user_data, LR_RAN_operating_cost_structure,LR_RAN_operating_cost,LR_RANtoCORE_operating_cost,LR_CORE_operating_cost,LR_Total_operating_cost_structure,...
          traffic_growth_snapshot_time, LR_network_information_growth_snapshot, LR_site_infrastructure, LR_network_information, LR_network_cost, LR_network_energy] =...
        get_process_data_from_external_world();
    
    table_p3_headers{3} = traffic_growth_snapshot_time;
    set(hp3table, 'ColumnName', table_p3_headers);     
                          
    cogs = (sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_site_rental) +...
            sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_network_operation_maintenance) +...
            sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_fixed_energy_consumption) +...
            sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_current_variable_energy_consumption) +...
            sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_leased_transmission_lines) +...
            sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_personnel) +...
            sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_other) +...
            sum(LR_network_cost.all_RAN.operating_cost.cogs_RANtoCORE_leased_transmission_lines) +...
            sum(LR_network_cost.all_RAN.operating_cost.cogs_RANtoCORE_network_operation_maintenance) +...
            sum(LR_network_cost.all_RAN.operating_cost.cogs_RANtoCORE_other) +...
            sum(LR_network_cost.all_RAN.operating_cost.cogs_CORE_fixed_energy_consumption) +...
            sum(LR_network_cost.all_RAN.operating_cost.cogs_CORE_current_variable_energy_consumption) +...
            sum(LR_network_cost.all_RAN.operating_cost.cogs_CORE_network_operation_maintenance) +...
            sum(LR_network_cost.all_RAN.operating_cost.cogs_CORE_personnel) +...
            sum(LR_network_cost.all_RAN.operating_cost.cogs_CORE_other))/1000;
        
     opex = (sum(LR_network_cost.all_RAN.operating_cost.opex_interconnection_and_other_fees) +...
            sum(LR_network_cost.all_RAN.operating_cost.opex_selling_general_and_administrative))/1000;
       
        
     switch traffic_growth_snapshot_time
        case '2017'
            year = 'year_1';
        case '2018'
            year = 'year_2';
        case '2019'
            year = 'year_3';
        case '2020'
            year = 'year_4';
        case '2021'
            year = 'year_5';
     end   
     scenario ='medium';
     P_20xx_forecast = exp(market_demand_revenues.inverse_demand.(year).MNO_regional.(scenario).actual.price_log_resolution(end)); 
     %Q_20xx_forecast =  exp(market_demand_revenues.inverse_demand.(year).MNO_regional.(scenario).actual.quantity_log_resolution(end));
     %rev = 12*Q_20xx_forecast/(1+LR_inputs_market_industry.service.ULtoDLratio)*P_20xx_forecast/1000;
     
     MNO_region_traffic_GB_mon_DL = LR_network_information.all_RAN.total_throughput_Mbps *60*60*24*30/8/1024; % regional throughput in GB/mon (DL)
     rev =  12 * MNO_region_traffic_GB_mon_DL * P_20xx_forecast/1000;
       
                     
     ebitda = rev - cogs - opex;
    
     dep =(sum(LR_network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.CORE_common_network_elements) +...          
           sum(LR_network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.CORE_other_tangible_fixed_asset) +...
           sum(LR_network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.CORE_owned_transmission_lines) +...
           sum(LR_network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.CORE_PSnetwork_elements) +...
           sum(LR_network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.non_network_intangible_fixed_assets) +...
           sum(LR_network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.non_network_tangible_fixed_assets) +...
           sum(LR_network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.RANtoCORE_other_tangible_fixed_asset) +...
           sum(LR_network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.RANtoCORE_owned_transmission_lines) +...
           sum(LR_network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.RAN_basestations)  +...
           sum(LR_network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.RAN_controllers)  +...
           sum(LR_network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.RAN_other_tangible_fixed_asset)+...
           sum(LR_network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.RAN_owned_transmission_lines)+...
           sum(LR_network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.RAN_site_development)+...
           sum(LR_network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.RAN_site_equipment))/1000;
    
    amort = sum(LR_network_cost.all_RAN.fixed_asset_cost.spectrum_amortization.amortization)/1000;    
    ebit = ebitda-dep-amort;
    interest = LR_inputs_finance.income_expense.interest;
    ebt = ebit - interest;
    tax = ebt * LR_inputs_finance.income_expense.tax_rate;
    ni = ebt - tax;
    ocf = ni + dep + amort;
    
    cumulated_investments = (sum(LR_network_cost.all_RAN.investment_cost.RAN_site_development)+...
                        sum(LR_network_cost.all_RAN.investment_cost.RAN_site_equipment)+...
                        sum(LR_network_cost.all_RAN.investment_cost.RAN_basestations)+...
                        sum(LR_network_cost.all_RAN.investment_cost.RAN_controllers)+...
                        sum(LR_network_cost.all_RAN.investment_cost.RAN_owned_transmission_lines)+...
                        sum(LR_network_cost.all_RAN.investment_cost.RAN_other_tangible_fixed_asset)+...
                        sum(LR_network_cost.all_RAN.investment_cost.RANtoCORE_owned_transmission_lines)+...
                        sum(LR_network_cost.all_RAN.investment_cost.RANtoCORE_other_tangible_fixed_asset)+...
                        sum(LR_network_cost.all_RAN.investment_cost.CORE_PSnetwork_elements)+...
                        sum(LR_network_cost.all_RAN.investment_cost.CORE_common_network_elements)+...
                        sum(LR_network_cost.all_RAN.investment_cost.CORE_owned_transmission_lines)+...
                        sum(LR_network_cost.all_RAN.investment_cost.CORE_other_tangible_fixed_asset)+...
                        sum(LR_network_cost.all_RAN.investment_cost.non_network_tangible_fixed_assets)+...
                        sum(LR_network_cost.all_RAN.investment_cost.non_network_intangible_fixed_assets))/1000;  
                 
    annual_investments =  cumulated_investments/(LR_inputs_finance.current_year-inputs_finance.current_year); % need to find the investment for the corresponding year. Now i tak ethe average                
    fcf = ocf - annual_investments; 
    dcf = 0;
    npv= 0;
    
    tableData = get(hp3table,'Data');
    tableData(:,3) =  {num2str(rev,'%.0f'); ... % revenues
                         num2str(cogs,'%.0f'); ... % Cost of good sold
                         num2str(opex,'%.0f'); ... % Operating expenses
                         num2str(ebitda,'%.0f'); ... % EBITDA
                         num2str(dep,'%.0f'); ... % Depreciation
                         num2str(amort,'%.0f'); ... % Amortization
                         num2str(ebit,'%.0f'); ... % EBIT
                         num2str(interest,'%.0f'); ... % Financial income/expenses
                         num2str(ebt,'%.0f'); ... % Taxable income
                         num2str(tax,'%.0f'); ... % Taxes
                         num2str(ni,'%.0f'); ... % Net income
                         num2str(ocf,'%.0f') ; ... % Cash Flow from operations
                         num2str(annual_investments,'%.0f'); ... % Investments
                         num2str(fcf,'%.0f') ; ... % Free Cash Flow
                         '' ; ...   % gap 
                         num2str(cumulated_investments,'%.0f')}; % Cumulated investments
                     
    set(hp3table, 'Data', tableData);
    set(findobj('Tag','push_button_in_table'),'Enable','off');
end
%**************************************************************************
% Utility functions 
%**************************************************************************
function plotDefaultSites()   
    plot(ah,sites_x,sites_y,'s','MarkerEdgeColor',[0.4,0.4,0.4]);
    axis(area*resolution);
    %grid on; 
end

function guidirty(fh,yes_no)
    setappdata(fh,'Dirty',yes_no);
    % Disable or enable the File->Save item according to yes_no
%     saveitem = findobj(fh,'Label','Save');
%     if yes_no
%         set(saveitem,'Enable','on')
%     else
%         set(saveitem,'Enable','off')
%     end
end


function [LR_MobileDataTraffic_TB_mon, LR_MobileDataTraffic_DL_TB_mon, LR_current_point, LR_OPEX_FIX_total, LR_OPEX_VAR_total, LR_OPEX_VAR_total_current,...
          LR_OPEX_total, LR_OPEX_total_current, LR_network_throughput_regional_TB_mon, LR_network_throughput_regional_DL_TB_mon,LR_Max_Traffic_to_be_satisfied_regional_TB_mon, ...
          LR_Max_Traffic_to_be_satisfied_regional_DL_TB_mon, LR_Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon, LR_Max_Traffic_to_be_satisfied_techlimit_regional_DL_TB_mon,...
          LR_actual_max_network_capacity_regional_DL_TB_mon, LR_Average_Total_Cost, LR_Average_Total_Cost_current, LR_Average_Fixed_Cost, LR_Average_Variable_Cost, LR_Marginal_Cost,...
          LR_inputs_market_industry,LR_inputs_finance, LR_inputs_technology, market_demand_revenues,average_investment_cost...
          LR_Efix_net, LR_Evar_net, LR_Average_Total_Cost_of_GB, LR_Average_user_data, LR_RAN_operating_cost_structure,LR_RAN_operating_cost,LR_RANtoCORE_operating_cost,LR_CORE_operating_cost,LR_Total_operating_cost_structure,...
          traffic_growth_snapshot_time, LR_network_information_growth_snapshot, LR_site_infrastructure, LR_network_information, LR_network_cost, LR_network_energy] =...
        get_process_data_from_external_world()


    LR_network_information_growth_snapshot = getappdata(hMainFigure, 'LR_network_information_growth_snapshot');
    LR_site_infrastructure = getappdata(hMainFigure, 'LR_site_infrastructure');
    LR_network_information = getappdata(hMainFigure, 'LR_network_information');
    LR_network_cost = getappdata(hMainFigure, 'LR_network_cost');
    LR_network_energy = getappdata(hMainFigure, 'LR_network_energy');
    LR_inputs_market_industry = getappdata(hMainFigure, 'LR_inputs_market_industry');
    LR_inputs_finance = getappdata(hMainFigure, 'LR_inputs_finance');
    LR_inputs_technology = getappdata(hMainFigure, 'LR_inputs_technology');
    market_demand_revenues = getappdata(hMainFigure, 'market_demand_revenues');
    
    traffic_growth_snapshot_time = LR_network_information_growth_snapshot.traffic_growth_snapshot_time{2};	
    
    
     LR_MobileDataTraffic_TB_mon =  LR_network_information.all_RAN.mobile_data_traffic_from_zero_Mbps * ...
                                    (1+LR_inputs_market_industry.service.ULtoDLratio)*60*60*24*30/8/1024/1024;
     
     LR_MobileDataTraffic_DL_TB_mon =  LR_network_information.all_RAN.mobile_data_traffic_from_zero_Mbps * ...
                                      60*60*24*30/8/1024/1024;
                                
    x = LR_network_information.all_RAN.mobile_data_traffic_from_zero_Mbps(LR_network_information.all_RAN.mobile_data_traffic_from_zero_Mbps < LR_network_information.all_RAN.total_throughput_Mbps);
    LR_current_point = length(x);
    
    LR_current_point = length(x);
    
    LR_OPEX_FIX_total = (sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_site_rental) +...
                     sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_network_operation_maintenance) +...
                     sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_fixed_energy_consumption) +...
                     sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_leased_transmission_lines) +...
                     sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_personnel) +...
                     sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_other) +...
                     sum(LR_network_cost.all_RAN.operating_cost.cogs_RANtoCORE_leased_transmission_lines) +...
                     sum(LR_network_cost.all_RAN.operating_cost.cogs_RANtoCORE_network_operation_maintenance) +...
                     sum(LR_network_cost.all_RAN.operating_cost.cogs_RANtoCORE_other) +...
                     sum(LR_network_cost.all_RAN.operating_cost.cogs_CORE_fixed_energy_consumption) +...
                     sum(LR_network_cost.all_RAN.operating_cost.cogs_CORE_network_operation_maintenance) +...
                     sum(LR_network_cost.all_RAN.operating_cost.cogs_CORE_personnel) +...
                     sum(LR_network_cost.all_RAN.operating_cost.cogs_CORE_other) +...
                     sum(LR_network_cost.all_RAN.operating_cost.opex_interconnection_and_other_fees) +...
                     sum(LR_network_cost.all_RAN.operating_cost.opex_selling_general_and_administrative))/12;
                
    LR_OPEX_VAR_total = (sum(cat(1,LR_network_cost.all_RAN.operating_cost.cogs_RAN_variable_energy_consumption{:})) +...
                        sum(cat(1,LR_network_cost.all_RAN.operating_cost.cogs_CORE_variable_energy_consumption{:})))/12;
     
    LR_OPEX_VAR_total_current = (sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_current_variable_energy_consumption) +...
                                sum(LR_network_cost.all_RAN.operating_cost.cogs_CORE_current_variable_energy_consumption))/12;
    
    LR_OPEX_total = LR_OPEX_FIX_total + LR_OPEX_VAR_total;
    
    LR_OPEX_total_current = LR_OPEX_FIX_total + LR_OPEX_VAR_total_current;
       
    LR_network_throughput_regional_TB_mon = LR_network_information.all_RAN.total_throughput_Mbps * ...
                                    (1+LR_inputs_market_industry.service.ULtoDLratio)*60*60*24*30/8/1024/1024; 
    
    LR_network_throughput_regional_DL_TB_mon = LR_network_information.all_RAN.total_throughput_Mbps * ...
                                            60*60*24*30/8/1024/1024;      
                                
    LR_Max_Traffic_to_be_satisfied_regional_TB_mon = LR_network_information.all_RAN.total_max_safe_throughput_Mbps * ...
                                    (1+LR_inputs_market_industry.service.ULtoDLratio)*60*60*24*30/8/1024/1024; 
   
    LR_Max_Traffic_to_be_satisfied_regional_DL_TB_mon = LR_network_information.all_RAN.total_max_safe_throughput_Mbps * ...
                                    60*60*24*30/8/1024/1024;    

    LR_Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon = LR_network_information.all_RAN.total_max_techlimit_throughput_Mbps * ...
                                    (1+LR_inputs_market_industry.service.ULtoDLratio)*60*60*24*30/8/1024/1024; 
    
    LR_Max_Traffic_to_be_satisfied_techlimit_regional_DL_TB_mon = LR_network_information.all_RAN.total_max_techlimit_throughput_Mbps * ...
                                    60*60*24*30/8/1024/1024;
                                
    LR_actual_max_network_capacity_regional_DL_TB_mon = LR_network_information.all_RAN.total_capacity_Mbps * ...
                                    (1+LR_inputs_market_industry.service.ULtoDLratio)*60*60*24*30/8/1024/1024; 
    
    LR_Average_Total_Cost = LR_OPEX_total./LR_MobileDataTraffic_DL_TB_mon;
    LR_Average_Total_Cost_current  = LR_OPEX_total_current / LR_network_throughput_regional_DL_TB_mon;
    
    LR_Average_Fixed_Cost = LR_OPEX_FIX_total./LR_MobileDataTraffic_DL_TB_mon;
    
    LR_Average_Variable_Cost = LR_OPEX_VAR_total./LR_MobileDataTraffic_DL_TB_mon;
    
    LR_Marginal_Cost = [0 diff(LR_OPEX_total)./diff(LR_MobileDataTraffic_DL_TB_mon)];    
       
    LR_Efix_net = (sum(LR_network_energy.all_RAN.energy_RAN.fixed_energy_consumption_MWh) + sum(LR_network_energy.all_RAN.energy_CORE.fixed_energy_consumption_MWh))/12;
    
    LR_Evar_net = (sum(cat(1,LR_network_energy.all_RAN.energy_RAN.variable_energy_consumption_MWh{:})) + sum(cat(1,LR_network_energy.all_RAN.energy_CORE.variable_energy_consumption_MWh{:})))/12;
    
    LR_Average_Total_Cost_of_GB = LR_Average_Total_Cost/1024;
    
    LR_Average_user_data = (LR_MobileDataTraffic_DL_TB_mon*1024)./LR_network_information.all_RAN.data_subs;
    
    
    cumulated_investments = (sum(LR_network_cost.all_RAN.investment_cost.RAN_site_development)+...
                    sum(LR_network_cost.all_RAN.investment_cost.RAN_site_equipment)+...
                    sum(LR_network_cost.all_RAN.investment_cost.RAN_basestations)+...
                    sum(LR_network_cost.all_RAN.investment_cost.RAN_controllers)+...
                    sum(LR_network_cost.all_RAN.investment_cost.RAN_owned_transmission_lines)+...
                    sum(LR_network_cost.all_RAN.investment_cost.RAN_other_tangible_fixed_asset)+...
                    sum(LR_network_cost.all_RAN.investment_cost.RANtoCORE_owned_transmission_lines)+...
                    sum(LR_network_cost.all_RAN.investment_cost.RANtoCORE_other_tangible_fixed_asset)+...
                    sum(LR_network_cost.all_RAN.investment_cost.CORE_PSnetwork_elements)+...
                    sum(LR_network_cost.all_RAN.investment_cost.CORE_common_network_elements)+...
                    sum(LR_network_cost.all_RAN.investment_cost.CORE_owned_transmission_lines)+...
                    sum(LR_network_cost.all_RAN.investment_cost.CORE_other_tangible_fixed_asset)+...
                    sum(LR_network_cost.all_RAN.investment_cost.non_network_tangible_fixed_assets)+...
                    sum(LR_network_cost.all_RAN.investment_cost.non_network_intangible_fixed_assets));  
  
    average_investment_cost = cumulated_investments/12./LR_MobileDataTraffic_DL_TB_mon; 
    
    % pie chart

    LR_RAN_operating_cost_structure = [sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_site_rental)...
                                       sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_network_operation_maintenance)...
                                       sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_fixed_energy_consumption)+sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_current_variable_energy_consumption) ...
                                       sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_leased_transmission_lines)...
                                       sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_personnel)...
                                       sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_other)];

    LR_RAN_operating_cost  = sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_site_rental)+...
                            sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_network_operation_maintenance)+...
                            sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_fixed_energy_consumption)+ ...
                            sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_current_variable_energy_consumption) +...
                            sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_leased_transmission_lines)+...
                            sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_personnel)+...
                            sum(LR_network_cost.all_RAN.operating_cost.cogs_RAN_other);
   
   
    LR_RANtoCORE_operating_cost = sum(LR_network_cost.all_RAN.operating_cost.cogs_RANtoCORE_leased_transmission_lines) +...
                                 sum(LR_network_cost.all_RAN.operating_cost.cogs_RANtoCORE_network_operation_maintenance) +...
                                 sum(LR_network_cost.all_RAN.operating_cost.cogs_RANtoCORE_other);
   
    LR_CORE_operating_cost = sum(LR_network_cost.all_RAN.operating_cost.cogs_CORE_fixed_energy_consumption) +...
                              sum(LR_network_cost.all_RAN.operating_cost.cogs_CORE_current_variable_energy_consumption) +...
                              sum(LR_network_cost.all_RAN.operating_cost.cogs_CORE_network_operation_maintenance) +...
                              sum(LR_network_cost.all_RAN.operating_cost.cogs_CORE_personnel) +...
                              sum(LR_network_cost.all_RAN.operating_cost.cogs_CORE_other);
     
    LR_Total_operating_cost_structure = [LR_RAN_operating_cost...
                                          LR_RANtoCORE_operating_cost...
                                          LR_CORE_operating_cost ...
                                          sum(LR_network_cost.all_RAN.operating_cost.opex_interconnection_and_other_fees)...
                                          sum(LR_network_cost.all_RAN.operating_cost.opex_selling_general_and_administrative)];
    

end

function output_txt = datacursor(obj,event_obj)
      
pos = get(event_obj,'Position');
indexX = find([site_infrastructure(:).longitude] == pos(1));
indexY = find([site_infrastructure(:).latitude] == pos(2));
index = intersect(indexX,indexY);

output_txt = {  ['longitude: ',num2str(pos(1),4)],...
                ['latitude: ',num2str(pos(2),4)],...
                ['site_ID: ', site_infrastructure(index).site_ID],...
                ['site_type: ', site_infrastructure(index).site_type],...
                ['development_year: ', num2str(site_infrastructure(index).development_year)],'',...
                'Other information: ', 'configurations, bands, BWs, cells and basestations,', ...
                'capacity, throughput, throughput_in_BH, max_safe_throughput,',...
                'max_techlimit_throughput, load, load_in_BH, etc'};


    SR_RAN_site_operating_cost_structure = [network_cost.all_RAN.operating_cost.cogs_RAN_site_rental(index)...
                                    network_cost.all_RAN.operating_cost.cogs_RAN_network_operation_maintenance(index)...
                                    network_cost.all_RAN.operating_cost.cogs_RAN_fixed_energy_consumption(index)+network_cost.all_RAN.operating_cost.cogs_RAN_current_variable_energy_consumption(index) ...
                                    network_cost.all_RAN.operating_cost.cogs_RAN_leased_transmission_lines(index)...
                                    network_cost.all_RAN.operating_cost.cogs_RAN_personnel(index)...
                                    network_cost.all_RAN.operating_cost.cogs_RAN_other(index)];

                                
    labelssitepie = {'Site rental','Operation and Maintenance','Energy','Transmission','Personnel','Other'};
    pie(ahsouthwest,SR_RAN_site_operating_cost_structure(SR_RAN_site_operating_cost_structure>0));  
    legend(ahsouthwest,labelssitepie(SR_RAN_site_operating_cost_structure>0),'Location','southoutside','Orientation','vertical')
    title(ahsouthwest,[num2str(inputs_finance.current_year) ': Site operating cost structure' ],'fontweight','bold','fontsize',10);  

end

function output_txt = datacursor_LR(obj,event_obj)

         [LR_MobileDataTraffic_TB_mon, LR_MobileDataTraffic_DL_TB_mon, LR_current_point, LR_OPEX_FIX_total, LR_OPEX_VAR_total, LR_OPEX_VAR_total_current,...
          LR_OPEX_total, LR_OPEX_total_current, LR_network_throughput_regional_TB_mon, LR_network_throughput_regional_DL_TB_mon,LR_Max_Traffic_to_be_satisfied_regional_TB_mon, ...
          LR_Max_Traffic_to_be_satisfied_regional_DL_TB_mon, LR_Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon, LR_Max_Traffic_to_be_satisfied_techlimit_regional_DL_TB_mon,...
          LR_actual_max_network_capacity_regional_DL_TB_mon, LR_Average_Total_Cost, LR_Average_Total_Cost_current, LR_Average_Fixed_Cost, LR_Average_Variable_Cost, LR_Marginal_Cost,...
          LR_inputs_market_industry,LR_inputs_finance, LR_inputs_technology,market_demand_revenues,average_investment_cost...
          LR_Efix_net, LR_Evar_net, LR_Average_Total_Cost_of_GB, LR_Average_user_data, LR_RAN_operating_cost_structure,LR_RAN_operating_cost,LR_RANtoCORE_operating_cost,LR_CORE_operating_cost,LR_Total_operating_cost_structure,...
          traffic_growth_snapshot_time, LR_network_information_growth_snapshot, LR_site_infrastructure, LR_network_information, LR_network_cost, LR_network_energy] =...
        get_process_data_from_external_world();
    
pos = get(event_obj,'Position');
indexX = find([LR_site_infrastructure(:).longitude] == pos(1));
indexY = find([LR_site_infrastructure(:).latitude] == pos(2));
index = intersect(indexX,indexY);

output_txt = {  ['longitude: ',num2str(pos(1),4)],...
                ['latitude: ',num2str(pos(2),4)],...
                ['site_ID: ', LR_site_infrastructure(index).site_ID],...
                ['site_type: ', LR_site_infrastructure(index).site_type],...
                ['development_year: ', num2str(LR_site_infrastructure(index).development_year)],'',...
                'Other information: ', 'configurations, bands, BWs, cells and basestations,', ...
                'capacity, throughput, throughput_in_BH, max_safe_throughput,',...
                'max_techlimit_throughput, load, load_in_BH, etc'};


    LR_RAN_site_operating_cost_structure = [LR_network_cost.all_RAN.operating_cost.cogs_RAN_site_rental(index)...
                                    LR_network_cost.all_RAN.operating_cost.cogs_RAN_network_operation_maintenance(index)...
                                    LR_network_cost.all_RAN.operating_cost.cogs_RAN_fixed_energy_consumption(index)+LR_network_cost.all_RAN.operating_cost.cogs_RAN_current_variable_energy_consumption(index) ...
                                    LR_network_cost.all_RAN.operating_cost.cogs_RAN_leased_transmission_lines(index)...
                                    LR_network_cost.all_RAN.operating_cost.cogs_RAN_personnel(index)...
                                    LR_network_cost.all_RAN.operating_cost.cogs_RAN_other(index)];

                                
    labelssitepie = {'Site rental','Operation and Maintenance','Energy','Transmission','Personnel','Other'};
    pie(ahsoutheast,LR_RAN_site_operating_cost_structure(LR_RAN_site_operating_cost_structure>0));  
    legend(ahsoutheast,labelssitepie(LR_RAN_site_operating_cost_structure>0),'Location','southoutside','Orientation','vertical')
    title(ahsoutheast,[num2str(LR_inputs_finance.current_year) ': Site operating cost structure' ],'fontweight','bold','fontsize',10);  

end

function [SR_MobileDataTraffic_TB_mon, SR_MobileDataTraffic_DL_TB_mon, current_point, OPEX_total, network_throughput_regional_TB_mon,...                                 
    Max_Traffic_to_be_satisfied_regional_TB_mon, Max_Traffic_to_be_satisfied_regional_DL_TB_mon,actual_max_network_capacity_regional_DL_TB_mon,... 
    Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon, Max_Traffic_to_be_satisfied_techlimit_regional_DL_TB_mon,...
    Average_Total_Cost,Average_Total_Cost_current, Average_Fixed_Cost,Average_Variable_Cost,Marginal_Cost, ...
    Efix_net, Evar_net, Average_Total_Cost_of_GB, Average_user_data,...
    SR_RAN_operating_cost_structure,SR_Total_operating_cost_structure] ...
    =  initial_figure_calculations_SR()
    

     SR_MobileDataTraffic_TB_mon =  network_information.all_RAN.mobile_data_traffic_from_zero_Mbps * ...
                                    (1+inputs_market_industry.service.ULtoDLratio)*60*60*24*30/8/1024/1024;
     
     SR_MobileDataTraffic_DL_TB_mon =  network_information.all_RAN.mobile_data_traffic_from_zero_Mbps * ...
                                      60*60*24*30/8/1024/1024;
                                
    x = network_information.all_RAN.mobile_data_traffic_from_zero_Mbps(network_information.all_RAN.mobile_data_traffic_from_zero_Mbps < network_information.all_RAN.total_throughput_Mbps);
    current_point = length(x);
    
    OPEX_FIX_total = (sum(network_cost.all_RAN.operating_cost.cogs_RAN_site_rental) +...
                     sum(network_cost.all_RAN.operating_cost.cogs_RAN_network_operation_maintenance) +...
                     sum(network_cost.all_RAN.operating_cost.cogs_RAN_fixed_energy_consumption) +...
                     sum(network_cost.all_RAN.operating_cost.cogs_RAN_leased_transmission_lines) +...
                     sum(network_cost.all_RAN.operating_cost.cogs_RAN_personnel) +...
                     sum(network_cost.all_RAN.operating_cost.cogs_RAN_other) +...
                     sum(network_cost.all_RAN.operating_cost.cogs_RANtoCORE_leased_transmission_lines) +...
                     sum(network_cost.all_RAN.operating_cost.cogs_RANtoCORE_network_operation_maintenance) +...
                     sum(network_cost.all_RAN.operating_cost.cogs_RANtoCORE_other) +...
                     sum(network_cost.all_RAN.operating_cost.cogs_CORE_fixed_energy_consumption) +...
                     sum(network_cost.all_RAN.operating_cost.cogs_CORE_network_operation_maintenance) +...
                     sum(network_cost.all_RAN.operating_cost.cogs_CORE_personnel) +...
                     sum(network_cost.all_RAN.operating_cost.cogs_CORE_other) +...
                     sum(network_cost.all_RAN.operating_cost.opex_interconnection_and_other_fees) +...
                     sum(network_cost.all_RAN.operating_cost.opex_selling_general_and_administrative))/12;
                
    OPEX_VAR_total = (sum(cat(1,network_cost.all_RAN.operating_cost.cogs_RAN_variable_energy_consumption{:})) +...
                        sum(cat(1,network_cost.all_RAN.operating_cost.cogs_CORE_variable_energy_consumption{:})))/12;
     
    OPEX_VAR_total_current = (sum(network_cost.all_RAN.operating_cost.cogs_RAN_current_variable_energy_consumption) +...
                                sum(network_cost.all_RAN.operating_cost.cogs_CORE_current_variable_energy_consumption))/12;
    
    OPEX_total = OPEX_FIX_total + OPEX_VAR_total;
    
    OPEX_total_current = OPEX_FIX_total + OPEX_VAR_total_current;
       
    network_throughput_regional_TB_mon = network_information.all_RAN.total_throughput_Mbps * ...
                                    (1+inputs_market_industry.service.ULtoDLratio)*60*60*24*30/8/1024/1024; 
    
    network_throughput_regional_DL_TB_mon = network_information.all_RAN.total_throughput_Mbps * ...
                                            60*60*24*30/8/1024/1024;      
                                
    Max_Traffic_to_be_satisfied_regional_TB_mon = network_information.all_RAN.total_max_safe_throughput_Mbps * ...
                                    (1+inputs_market_industry.service.ULtoDLratio)*60*60*24*30/8/1024/1024; 
   
    Max_Traffic_to_be_satisfied_regional_DL_TB_mon = network_information.all_RAN.total_max_safe_throughput_Mbps * ...
                                    60*60*24*30/8/1024/1024;    

    Max_Traffic_to_be_satisfied_techlimit_regional_TB_mon = network_information.all_RAN.total_max_techlimit_throughput_Mbps * ...
                                    (1+inputs_market_industry.service.ULtoDLratio)*60*60*24*30/8/1024/1024; 
    
    Max_Traffic_to_be_satisfied_techlimit_regional_DL_TB_mon = network_information.all_RAN.total_max_techlimit_throughput_Mbps * ...
                                    60*60*24*30/8/1024/1024;
                                
    actual_max_network_capacity_regional_DL_TB_mon = network_information.all_RAN.total_capacity_Mbps * ...
                                    (1+inputs_market_industry.service.ULtoDLratio)*60*60*24*30/8/1024/1024; 
    
    Average_Total_Cost = OPEX_total./SR_MobileDataTraffic_DL_TB_mon;
    Average_Total_Cost_current  = OPEX_total_current / network_throughput_regional_DL_TB_mon;
    
    Average_Fixed_Cost = OPEX_FIX_total./SR_MobileDataTraffic_DL_TB_mon;
    
    Average_Variable_Cost = OPEX_VAR_total./SR_MobileDataTraffic_DL_TB_mon;
    
    Marginal_Cost = [0 diff(OPEX_total)./diff(SR_MobileDataTraffic_DL_TB_mon)];    
       
    Efix_net = (sum(network_energy.all_RAN.energy_RAN.fixed_energy_consumption_MWh) + sum(network_energy.all_RAN.energy_CORE.fixed_energy_consumption_MWh))/12;
    
    Evar_net = (sum(cat(1,network_energy.all_RAN.energy_RAN.variable_energy_consumption_MWh{:})) + sum(cat(1,network_energy.all_RAN.energy_CORE.variable_energy_consumption_MWh{:})))/12;
    
    Average_Total_Cost_of_GB = Average_Total_Cost/1024;
    
    Average_user_data = (SR_MobileDataTraffic_DL_TB_mon*1024)./network_information.all_RAN.data_subs;
    
    % pie chart
                 
    SR_RAN_operating_cost_structure = [sum(network_cost.all_RAN.operating_cost.cogs_RAN_site_rental)...
                                       sum(network_cost.all_RAN.operating_cost.cogs_RAN_network_operation_maintenance)...
                                       sum(network_cost.all_RAN.operating_cost.cogs_RAN_fixed_energy_consumption)+sum(network_cost.all_RAN.operating_cost.cogs_RAN_current_variable_energy_consumption) ...
                                       sum(network_cost.all_RAN.operating_cost.cogs_RAN_leased_transmission_lines)...
                                       sum(network_cost.all_RAN.operating_cost.cogs_RAN_personnel)...
                                       sum(network_cost.all_RAN.operating_cost.cogs_RAN_other)];
    
   SR_RAN_operating_cost  = sum(network_cost.all_RAN.operating_cost.cogs_RAN_site_rental)+...
                            sum(network_cost.all_RAN.operating_cost.cogs_RAN_network_operation_maintenance)+...
                            sum(network_cost.all_RAN.operating_cost.cogs_RAN_fixed_energy_consumption)+ ...
                            sum(network_cost.all_RAN.operating_cost.cogs_RAN_current_variable_energy_consumption) +...
                            sum(network_cost.all_RAN.operating_cost.cogs_RAN_leased_transmission_lines)+...
                            sum(network_cost.all_RAN.operating_cost.cogs_RAN_personnel)+...
                            sum(network_cost.all_RAN.operating_cost.cogs_RAN_other);
   
   
   SR_RANtoCORE_operating_cost = sum(network_cost.all_RAN.operating_cost.cogs_RANtoCORE_leased_transmission_lines) +...
                                 sum(network_cost.all_RAN.operating_cost.cogs_RANtoCORE_network_operation_maintenance) +...
                                 sum(network_cost.all_RAN.operating_cost.cogs_RANtoCORE_other);
   
     SR_CORE_operating_cost = sum(network_cost.all_RAN.operating_cost.cogs_CORE_fixed_energy_consumption) +...
                              sum(network_cost.all_RAN.operating_cost.cogs_CORE_current_variable_energy_consumption) +...
                              sum(network_cost.all_RAN.operating_cost.cogs_CORE_network_operation_maintenance) +...
                              sum(network_cost.all_RAN.operating_cost.cogs_CORE_personnel) +...
                              sum(network_cost.all_RAN.operating_cost.cogs_CORE_other);
     
     SR_Total_operating_cost_structure = [SR_RAN_operating_cost...
                                          SR_RANtoCORE_operating_cost...
                                          SR_CORE_operating_cost ...
                                          sum(network_cost.all_RAN.operating_cost.opex_interconnection_and_other_fees)...
                                          sum(network_cost.all_RAN.operating_cost.opex_selling_general_and_administrative)];

                    
end

function [table_p3_headers,table_p3_columnwidth,table_p3_colFormat,table_p3_data]  =  create_table_income_statement_data()

    table_p3_headers = {'EUR thousand', num2str(inputs_finance.current_year), 'Future'};
    table_p3_columnwidth = {160, 'auto', 'auto'};
    table_p3_colFormat = {'char','short','short'};  
    
                          
    cogs = (sum(network_cost.all_RAN.operating_cost.cogs_RAN_site_rental) +...
            sum(network_cost.all_RAN.operating_cost.cogs_RAN_network_operation_maintenance) +...
            sum(network_cost.all_RAN.operating_cost.cogs_RAN_fixed_energy_consumption) +...
            sum(network_cost.all_RAN.operating_cost.cogs_RAN_current_variable_energy_consumption) +...
            sum(network_cost.all_RAN.operating_cost.cogs_RAN_leased_transmission_lines) +...
            sum(network_cost.all_RAN.operating_cost.cogs_RAN_personnel) +...
            sum(network_cost.all_RAN.operating_cost.cogs_RAN_other) +...
            sum(network_cost.all_RAN.operating_cost.cogs_RANtoCORE_leased_transmission_lines) +...
            sum(network_cost.all_RAN.operating_cost.cogs_RANtoCORE_network_operation_maintenance) +...
            sum(network_cost.all_RAN.operating_cost.cogs_RANtoCORE_other) +...
            sum(network_cost.all_RAN.operating_cost.cogs_CORE_fixed_energy_consumption) +...
            sum(network_cost.all_RAN.operating_cost.cogs_CORE_current_variable_energy_consumption) +...
            sum(network_cost.all_RAN.operating_cost.cogs_CORE_network_operation_maintenance) +...
            sum(network_cost.all_RAN.operating_cost.cogs_CORE_personnel) +...
            sum(network_cost.all_RAN.operating_cost.cogs_CORE_other))/1000;
        
     opex = (sum(network_cost.all_RAN.operating_cost.opex_interconnection_and_other_fees) +...
            sum(network_cost.all_RAN.operating_cost.opex_selling_general_and_administrative))/1000;
       
     rev = market_demand_revenues.annual_revenue_mno_region(end)/1000;
     %rev2020 = rev/(1+inputs_market_industry.service.ULtoDLratio);
%     market_demand_revenues.annual_market_revenue_low =0;
%     rev2020 = 12*market_demand_revenues.annual_market_revenue_low(end)*inputs_market_industry.mobile_market.market_share *...
%             market_demand_revenues.operator_region_data_weight_factor/1000;
        
     ebitda = rev - cogs - opex;
    
     dep =(sum(network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.CORE_common_network_elements) +...          
           sum(network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.CORE_other_tangible_fixed_asset) +...
           sum(network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.CORE_owned_transmission_lines) +...
           sum(network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.CORE_PSnetwork_elements) +...
           sum(network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.non_network_intangible_fixed_assets) +...
           sum(network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.non_network_tangible_fixed_assets) +...
           sum(network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.RANtoCORE_other_tangible_fixed_asset) +...
           sum(network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.RANtoCORE_owned_transmission_lines) +...
           sum(network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.RAN_basestations)  +...
           sum(network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.RAN_controllers)  +...
           sum(network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.RAN_other_tangible_fixed_asset)+...
           sum(network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.RAN_owned_transmission_lines)+...
           sum(network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.RAN_site_development)+...
           sum(network_cost.all_RAN.fixed_asset_cost.fixed_asset_depreciation.RAN_site_equipment))/1000;
    
    amort = sum(network_cost.all_RAN.fixed_asset_cost.spectrum_amortization.amortization)/1000;    
    ebit = ebitda-dep-amort;
    interest = inputs_finance.income_expense.interest;
    ebt = ebit - interest;
    tax = ebt * inputs_finance.income_expense.tax_rate;
    ni = ebt - tax;
    ocf = ni + dep + amort;
    investments = 0;
    fcf = ocf - investments;
    
    table_p3_data = {'Revenue',num2str(rev,'%.0f'),[] ; ...
                     'Cost of good sold',num2str(cogs,'%.0f'),[] ; ...
                     'Operating expenses',num2str(opex,'%.0f'),[] ; ...
                     'EBITDA',num2str(ebitda,'%.0f'),[] ; ...
                     'Depreciation',num2str(dep,'%.0f'),[] ; ...
                     'Amortization',num2str(amort,'%.0f'),[]; ...
                     'EBIT',num2str(ebit,'%.0f'),[]; ...
                     'Financial income/expenses',num2str(interest,'%.0f'),[] ; ...
                     'Taxable income',num2str(ebt,'%.0f'),[] ; ...
                     'Taxes',num2str(tax,'%.0f'),[] ; ...
                     'Net income',num2str(ni,'%.0f'),[] ; ...
                     'Cash Flow from operations',num2str(ocf,'%.0f'),[] ; ...
                     'Investments',num2str(investments,'%.0f'),[] ; ...
                     'Free Cash Flow',num2str(fcf,'%.0f'),[] ; ...
                     '',[],[] ; ...
                     'Cumulated investments',num2str(investments,'%.0f'),[]};

end
end